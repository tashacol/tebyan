<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری محققین</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Vazirmatn", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 0;
        }
        .hidden { display: none !important; }
        
        /* Login Form Styles */
        #login-form { display: flex; flex-direction: column; gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        label { margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="password"], select, textarea {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
        }
        button {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
        }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: button-loading-spinner 1s ease infinite; }
        @keyframes button-loading-spinner { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }

        /* Dashboard Styles */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        #logout-btn { background-color: #e74c3c; }
        #logout-btn:hover { background-color: #c0392b; }
        
        /* Article List Styles */
        .article-card {
            background-color: #ecf0f1;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-right: 5px solid #3498db;
        }
        .article-card-header { display: flex; justify-content: space-between; align-items: center; }
        .article-title { font-size: 1.2em; font-weight: bold; }
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            color: white;
            font-size: 0.9em;
            margin-left: 5px;
        }
        .status-supervisor-1 { border-color: #f39c12; }
        .status-supervisor-5 { border-color: #2ecc71; }
        .status-supervisor-0 { border-color: #e74c3c; }
        .article-details { margin-top: 15px; }

        /* Modal Styles */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 30px; border-radius: 10px; width: 90%;
            max-width: 700px; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 2em; cursor: pointer; border: none; background: none;}
        .edit-section { margin-bottom: 20px; }
        .edit-section button { margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login Page -->
        <div id="login-page">
            <h1>ورود به پنل کاربری محققین</h1>
            <form id="login-form">
                <div class="form-group">
                    <label for="national-id">کد ملی (نام کاربری)</label>
                    <input type="text" id="national-id" required>
                </div>
                <div class="form-group">
                    <label for="password">رمز عبور</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" id="login-btn"><span class="btn-text">ورود</span></button>
                <p id="login-error" style="color: red; margin-top: 10px; text-align: center;"></p>
            </form>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="hidden">
            <div class="dashboard-header">
                <h2 id="welcome-message"></h2>
                <button id="logout-btn">خروج</button>
            </div>
            <h3>مقالات من</h3>
            <button id="add-new-article-btn"><span class="btn-text">افزودن مقاله جدید</span></button>
            <div id="articles-container" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Modals will be rendered here by JavaScript -->
    <div id="modal-container"></div>

<script>
    // -------------------------------------------------------------------
    // --- آدرس وب اپلیکیشن گوگل اسکریپت جدید را در اینجا جایگزین کنید ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJhCyAzJ1abka2jLkvJtREn2Cqeq3T1HVKz2lA7tZnzvuK20N4wm4NEHIlE137hs7S/exec';
    // -------------------------------------------------------------------

    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const modalContainer = document.getElementById('modal-container');
    
    // تابع متمرکز برای ارسال درخواست به Google Apps Script
    async function callApi(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        const requestBody = { action, params };
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // مطابق نمونه موفق
                body: JSON.stringify(requestBody)
            });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('API Call Failed:', error);
            alert('خطا در ارتباط با سرور. لطفا کنسول مرورگر را بررسی کنید.');
            return { status: 'error', message: error.message };
        } finally {
            if(button) setButtonLoading(button, false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const user = getStoredUser();
        if (user) {
            showDashboard(user);
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        const nationalId = document.getElementById('national-id').value;
        const password = document.getElementById('password').value;
        const loginButton = document.getElementById('login-btn');
        
        const response = await callApi('login', { nationalId, password }, loginButton);
        
        if (response && response.status === 'success') {
            storeUser(response.user);
            showDashboard(response.user);
        } else {
            loginError.textContent = response.message || 'خطایی رخ داد.';
        }
    });

    function showDashboard(user) {
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        document.getElementById('welcome-message').textContent = `خوش آمدید، ${user.name}`;
        document.getElementById('logout-btn').onclick = handleLogout;
        document.getElementById('add-new-article-btn').onclick = showNewArticleModal;
        loadArticles(user.nationalId);
    }

    async function loadArticles(nationalId) {
        const articlesContainer = document.getElementById('articles-container');
        articlesContainer.innerHTML = '<p>در حال بارگذاری مقالات...</p>';
        
        const response = await callApi('getArticles', { nationalId });
        
        if (response && response.status === 'success') {
            renderArticles(response.articles);
        } else {
            articlesContainer.innerHTML = `<p>خطا در دریافت مقالات: ${response.message}</p>`;
        }
    }

    function renderArticles(articles) {
        const articlesContainer = document.getElementById('articles-container');
        articlesContainer.innerHTML = '';
        if (articles.length === 0) {
            articlesContainer.innerHTML = '<p>شما هنوز مقاله‌ای ثبت نکرده‌اید.</p>';
        }

        let hasPendingArticle = articles.some(a => a.articleStatus == 1 || a.articleStatus == 2);
        document.getElementById('add-new-article-btn').disabled = hasPendingArticle;

        articles.forEach(article => {
            const card = document.createElement('div');
            card.className = `article-card status-supervisor-${article.supervisorStatus}`;
            
            const [supervisorStatusText, supervisorStatusColor] = getStatusInfo('supervisor', article.supervisorStatus);
            const [articleStatusText, articleStatusColor] = getStatusInfo('article', article.articleStatus);

            card.innerHTML = `
                <div class="article-card-header">
                    <span class="article-title">${article.title}</span>
                    <div>
                        <span class="status-badge" style="background-color: ${supervisorStatusColor};">${supervisorStatusText}</span>
                        <span class="status-badge" style="background-color: ${articleStatusColor};">${articleStatusText}</span>
                    </div>
                </div>
                <div class="article-details">
                    <p>شناسه مقاله: ${article.articleId}</p>
                    <button>مشاهده و ویرایش</button>
                </div>
            `;
            card.querySelector('button').onclick = () => showEditArticleModal(article);
            articlesContainer.appendChild(card);
        });
    }

    async function showNewArticleModal() {
        const button = document.getElementById('add-new-article-btn');
        const res = await callApi('getSupervisors', {}, button);
        if (!res || res.status !== 'success') {
            alert('خطا در دریافت لیست اساتید.');
            return;
        }
        const supervisorOptions = res.supervisors.map(name => `<option value="${name}">${name}</option>`).join('');
        const modalContent = `
            <form id="new-article-form">
                <div class="form-group"><label for="affiliation">وابستگی سازمانی</label><input type="text" id="affiliation" required></div>
                <div class="form-group"><label for="article-title">عنوان مقاله</label><input type="text" id="article-title" required></div>
                <div class="form-group"><label for="knowledge-area">حیطه دانشی</label><input type="text" id="knowledge-area" required></div>
                <div class="form-group"><label for="topic-reason">دلیل انتخاب موضوع</label><textarea id="topic-reason" rows="3" required></textarea></div>
                <div class="form-group"><label for="supervisor-select">استاد راهنما</label><select id="supervisor-select" required><option value="">انتخاب کنید...</option>${supervisorOptions}</select></div>
                <button type="submit" id="submit-new-article-btn"><span class="btn-text">ارسال جهت بررسی</span></button>
            </form>`;
        renderModal('ثبت مقاله جدید', modalContent);
        document.getElementById('new-article-form').onsubmit = handleNewArticleSubmit;
    }

    async function handleNewArticleSubmit(e) {
        e.preventDefault();
        const user = getStoredUser();
        const data = {
            researcherName: user.name, researcherId: user.nationalId,
            affiliation: document.getElementById('affiliation').value,
            title: document.getElementById('article-title').value,
            knowledgeArea: document.getElementById('knowledge-area').value,
            topicReason: document.getElementById('topic-reason').value,
            supervisor: document.getElementById('supervisor-select').value
        };
        const button = document.getElementById('submit-new-article-btn');
        const response = await callApi('submitNewArticle', { data }, button);
        if(response && response.status === 'success'){
            alert(response.message);
            closeAllModals();
            loadArticles(user.nationalId);
        } else {
            alert('خطا: ' + response.message);
        }
    }

    function showEditArticleModal(article) {
        const canEdit = article.supervisorStatus == 5;
        const disabledAttr = canEdit ? '' : 'disabled';
        const notice = canEdit ? '' : '<p style="color: #e67e22; text-align: center;">تا زمان تایید استاد، امکان ویرایش محتوای مقاله وجود ندارد.</p>';
        
        const modalContent = `
            ${notice}
            <input type="hidden" id="editing-article-id" value="${article.articleId}">
            <div class="edit-section"><label for="edit-abstract">چکیده</label><textarea id="edit-abstract" rows="5" ${disabledAttr}>${article.abstract || ''}</textarea><button ${disabledAttr}>ذخیره چکیده</button></div>
            <div class="edit-section"><label for="edit-keywords">کلیدواژه‌ها</label><input type="text" id="edit-keywords" value="${article.keywords || ''}" ${disabledAttr}><button ${disabledAttr}>ذخیره کلیدواژه‌ها</button></div>
            <div class="edit-section"><label for="edit-introduction">مقدمه</label><textarea id="edit-introduction" rows="10" ${disabledAttr}>${article.introduction || ''}</textarea><button ${disabledAttr}>ذخیره مقدمه</button></div>
            <div class="edit-section"><label for="edit-body">بدنه مقاله</label><textarea id="edit-body" rows="15" ${disabledAttr}>${article.body || ''}</textarea><button ${disabledAttr}>ذخیره بدنه مقاله</button></div>
            <div class="edit-section"><label for="edit-conclusion">نتیجه‌گیری</label><textarea id="edit-conclusion" rows="8" ${disabledAttr}>${article.conclusion || ''}</textarea><button ${disabledAttr}>ذخیره نتیجه‌گیری</button></div>
            <div class="edit-section"><label for="edit-references">منابع</label><textarea id="edit-references" rows="8" ${disabledAttr}>${article.references || ''}</textarea><button ${disabledAttr}>ذخیره منابع</button></div>
        `;
        renderModal(`ویرایش مقاله: ${article.title}`, modalContent);

        // Add event listeners for save buttons
        const sections = ['abstract', 'keywords', 'introduction', 'body', 'conclusion', 'references'];
        sections.forEach(sec => {
            const btn = document.querySelector(`.edit-section:has(#edit-${sec}) button`);
            if(btn) btn.onclick = (e) => saveSection(e.target, sec);
        });
    }

    async function saveSection(button, sectionName) {
        const articleId = document.getElementById('editing-article-id').value;
        const content = document.getElementById(`edit-${sectionName}`).value;
        const response = await callApi('updateArticleSection', { articleId, section: sectionName, content }, button);
        if(response && response.status === 'success'){
            alert(response.message);
        } else {
            alert('خطا در ذخیره: ' + (response.message || 'خطای نامشخص'));
        }
    }

    function handleLogout() {
        localStorage.removeItem('currentUser');
        window.location.reload();
    }
    
    // --- توابع کمکی ---
    function renderModal(title, content, extraClasses = '') {
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content ${extraClasses}"><div class="modal-header"><h3>${title}</h3><button class="close-btn">&times;</button></div>${content}</div></div>`;
        modalContainer.querySelector('.close-btn').onclick = closeAllModals;
    }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    function setButtonLoading(button, isLoading) { if(!button) return; button.disabled = isLoading; button.classList.toggle('btn-loading', isLoading); }
    function storeUser(user) { localStorage.setItem('currentUser', JSON.stringify(user)); }
    function getStoredUser() { return JSON.parse(localStorage.getItem('currentUser')); }
    
    function getStatusInfo(type, code) {
        const statusMap = {
            supervisor: { '1': ['منتظر تایید استاد', '#f39c12'], '5': ['تایید شده توسط استاد', '#2ecc71'], '0': ['رد شده توسط استاد', '#e74c3c'] },
            article: { '1': ['در دست بررسی', '#3498db'], '2': ['نیازمند ویرایش', '#e67e22'], '5': ['تایید نهایی', '#27ae60'], '0': ['رد شده', '#c0392b'] }
        };
        return (statusMap[type] && statusMap[type][String(code)]) || ['نامشخص', '#7f8c8d'];
    }
</script>

</body>
</html>
