<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری محققین</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Vazirmatn", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9; color: #333; margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 900px; background-color: #fff; padding: 30px;
            border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        h1, h2, h3 {
            color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0;
        }
        .hidden { display: none !important; }
        
        /* Form & Button Styles */
        .form-group { display: flex; flex-direction: column; margin-bottom: 15px; }
        label { margin-bottom: 5px; font-weight: 600; color: #555; }
        input[type="text"], input[type="password"], select, textarea {
            padding: 12px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px;
            font-family: inherit; transition: border-color 0.3s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
        button {
            padding: 12px 20px; background-color: #3498db; color: white; border: none;
            border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; position: relative;
        }
        button:hover:not(:disabled) { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-loading .btn-text { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; top: 0; left: 0; right: 0; bottom: 0; margin: auto; border: 3px solid transparent; border-top-color: #ffffff; border-radius: 50%; animation: spin 1s ease infinite; }
        @keyframes spin { from { transform: rotate(0turn); } to { transform: rotate(1turn); } }
        
        /* Dashboard & Article Styles */
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        #logout-btn { background-color: #e74c3c; }
        #logout-btn:hover { background-color: #c0392b; }
        .article-card { background-color: #ecf0f1; padding: 20px; margin-bottom: 15px; border-radius: 8px; border-right: 5px solid #3498db; }
        .article-card-header { display: flex; justify-content: space-between; align-items: center; }
        .article-title { font-size: 1.2em; font-weight: bold; }
        .status-badge { padding: 5px 12px; border-radius: 15px; color: white; font-size: 0.9em; margin-left: 5px; }
        .status-supervisor-1 { border-color: #f39c12; }
        .status-supervisor-5 { border-color: #2ecc71; }
        .status-supervisor-0 { border-color: #e74c3c; }
        .article-details { margin-top: 15px; }

        /* Modal & Wizard Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .close-btn { font-size: 2em; cursor: pointer; border: none; background: none;}
        .wizard-footer { display: flex; justify-content: space-between; margin-top: 20px; }
        .edit-section { margin-bottom: 20px; }
        .edit-section button { margin-top: 10px; }

        /* Supervisor Search Styles */
        .supervisor-search-container { position: relative; }
        #supervisor-results {
            list-style-type: none; margin: 5px 0 0; padding: 0; border: 1px solid #ccc;
            border-radius: 5px; position: absolute; background-color: white; width: 100%;
            max-height: 200px; overflow-y: auto; z-index: 1001;
        }
        #supervisor-results li { padding: 10px; cursor: pointer; }
        #supervisor-results li:hover { background-color: #f0f0f0; }
        #supervisor-results li .supervisor-id { font-size: 0.9em; color: #777; margin-right: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <!-- Login Page -->
        <div id="login-page">
            <h1>ورود به پنل کاربری محققین</h1>
            <form id="login-form">
                <div class="form-group"><label for="national-id">کد ملی</label><input type="text" id="national-id" required></div>
                <div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div>
                <button type="submit" id="login-btn"><span class="btn-text">ورود</span></button>
                <p id="login-error" style="color: red; margin-top: 10px; text-align: center;"></p>
            </form>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="hidden">
            <div class="dashboard-header"><h2 id="welcome-message"></h2><button id="logout-btn">خروج</button></div>
            <h3>مقالات من</h3>
            <button id="add-new-article-btn"><span class="btn-text">افزودن مقاله جدید</span></button>
            <div id="articles-container" style="margin-top: 20px;"></div>
        </div>
    </div>

    <!-- Modals will be rendered here by JavaScript -->
    <div id="modal-container"></div>

<script>
    // -------------------------------------------------------------------
    // --- آدرس وب اپلیکیشن گوگل اسکریپت جدید را در اینجا جایگزین کنید ---
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyJhCyAzJ1abka2jLkvJtREn2Cqeq3T1HVKz2lA7tZnzvuK20N4wm4NEHIlE137hs7S/exec';
    // -------------------------------------------------------------------

    const loginPage = document.getElementById('login-page');
    const dashboardPage = document.getElementById('dashboard-page');
    const loginForm = document.getElementById('login-form');
    const modalContainer = document.getElementById('modal-container');
    let allSupervisors = []; // برای ذخیره لیست اساتید
    let newArticleData = {}; // برای ذخیره اطلاعات فرم مرحله‌ای
    
    // تابع متمرکز برای ارسال درخواست به Google Apps Script
    async function callApi(action, params = {}, button = null) {
        if(button) setButtonLoading(button, true);
        const requestBody = { action, params };
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(requestBody)
            });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('API Call Failed:', error);
            alert('خطا در ارتباط با سرور. لطفا کنسول مرورگر را بررسی کنید.');
            return { status: 'error', message: error.message };
        } finally {
            if(button) setButtonLoading(button, false);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const user = getStoredUser();
        if (user) {
            showDashboard(user);
        }
    });

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        const nationalId = document.getElementById('national-id').value;
        const password = document.getElementById('password').value;
        const loginButton = document.getElementById('login-btn');
        const response = await callApi('login', { nationalId, password }, loginButton);
        if (response && response.status === 'success') {
            storeUser(response.user);
            showDashboard(response.user);
        } else {
            loginError.textContent = response.message || 'خطایی رخ داد.';
        }
    });

    function showDashboard(user) {
        loginPage.classList.add('hidden');
        dashboardPage.classList.remove('hidden');
        document.getElementById('welcome-message').textContent = `خوش آمدید، ${user.name}`;
        document.getElementById('logout-btn').onclick = handleLogout;
        document.getElementById('add-new-article-btn').onclick = startNewArticleWizard;
        loadArticles(user.nationalId);
    }

    async function loadArticles(nationalId) {
        const articlesContainer = document.getElementById('articles-container');
        articlesContainer.innerHTML = '<p>در حال بارگذاری مقالات...</p>';
        const response = await callApi('getArticles', { nationalId });
        if (response && response.status === 'success') {
            renderArticles(response.articles);
        } else {
            articlesContainer.innerHTML = `<p>خطا در دریافت مقالات: ${response.message}</p>`;
        }
    }

    function renderArticles(articles) {
        const articlesContainer = document.getElementById('articles-container');
        articlesContainer.innerHTML = '';
        if (articles.length === 0) articlesContainer.innerHTML = '<p>شما هنوز مقاله‌ای ثبت نکرده‌اید.</p>';

        let hasPendingArticle = articles.some(a => a.articleStatus == 1 || a.articleStatus == 2);
        document.getElementById('add-new-article-btn').disabled = hasPendingArticle;

        articles.forEach(article => {
            const card = document.createElement('div');
            card.className = `article-card status-supervisor-${article.supervisorStatus}`;
            const [supervisorStatusText, supervisorStatusColor] = getStatusInfo('supervisor', article.supervisorStatus);
            const [articleStatusText, articleStatusColor] = getStatusInfo('article', article.articleStatus);

            card.innerHTML = `
                <div class="article-card-header">
                    <span class="article-title">${article.title}</span>
                    <div>
                        <span class="status-badge" style="background-color: ${supervisorStatusColor};">${supervisorStatusText}</span>
                        <span class="status-badge" style="background-color: ${articleStatusColor};">${articleStatusText}</span>
                    </div>
                </div>
                <div class="article-details">
                    <p>شناسه مقاله: ${article.articleId}</p>
                    <button>مشاهده و ویرایش</button>
                </div>`;
            card.querySelector('button').onclick = () => showEditArticleModal(article);
            articlesContainer.appendChild(card);
        });
    }

    // --- New Article Wizard Logic ---
    async function startNewArticleWizard() {
        newArticleData = {}; // Reset data
        const button = document.getElementById('add-new-article-btn');
        const res = await callApi('getSupervisors', {}, button);
        if (res && res.status === 'success') {
            allSupervisors = res.supervisors;
            showWizardStep(1);
        } else {
            alert('خطا در دریافت لیست اساتید.');
        }
    }

    function showWizardStep(step) {
        let title = '', content = '';
        switch(step) {
            case 1:
                title = 'مرحله ۱: وابستگی سازمانی';
                content = `
                    <div class="form-group"><label for="affiliation">وابستگی سازمانی خود را وارد کنید</label><input type="text" id="affiliation" value="${newArticleData.affiliation || ''}" required></div>
                    <div class="wizard-footer"><button onclick="goToWizardStep(2, true)">بعدی</button></div>`;
                break;
            case 2:
                title = 'مرحله ۲: اطلاعات اولیه مقاله';
                content = `
                    <div class="form-group"><label for="article-title">عنوان مقاله</label><input type="text" id="article-title" value="${newArticleData.title || ''}" required></div>
                    <div class="form-group"><label for="knowledge-area">حیطه دانشی</label><input type="text" id="knowledge-area" value="${newArticleData.knowledgeArea || ''}" required></div>
                    <div class="form-group"><label for="topic-reason">دلیل انتخاب موضوع</label><textarea id="topic-reason" rows="3" required>${newArticleData.topicReason || ''}</textarea></div>
                    <div class="wizard-footer"><button class="secondary" onclick="goToWizardStep(1)">قبلی</button><button onclick="goToWizardStep(3, true)">بعدی</button></div>`;
                break;
            case 3:
                title = 'مرحله ۳: انتخاب استاد راهنما';
                content = `
                    <div class="form-group">
                        <label for="supervisor-search">جستجوی استاد (بر اساس نام یا کدملی)</label>
                        <div class="supervisor-search-container">
                            <input type="text" id="supervisor-search" placeholder="شروع به تایپ کنید..." autocomplete="off">
                            <ul id="supervisor-results" class="hidden"></ul>
                        </div>
                        <input type="hidden" id="selected-supervisor-id">
                        <input type="hidden" id="selected-supervisor-name">
                    </div>
                    <div class="wizard-footer"><button class="secondary" onclick="goToWizardStep(2)">قبلی</button><button id="submit-btn" onclick="handleNewArticleSubmit(event)">ثبت نهایی مقاله</button></div>`;
                break;
        }
        renderModal(title, content);
        if (step === 3) setupSupervisorSearch();
    }

    function goToWizardStep(step, validate = false) {
        if(validate) {
            // Simple validation
            const inputs = modalContainer.querySelectorAll('input[required], textarea[required]');
            for(const input of inputs) {
                if(!input.value.trim()) {
                    alert('لطفا تمام فیلدها را پر کنید.');
                    input.focus();
                    return;
                }
                newArticleData[input.id.replace('article-','')] = input.value.trim();
            }
        }
        showWizardStep(step);
    }

    async function handleNewArticleSubmit(event) {
        const supervisorId = document.getElementById('selected-supervisor-id').value;
        const supervisorName = document.getElementById('selected-supervisor-name').value;
        if (!supervisorId || !supervisorName) {
            alert('لطفا یک استاد راهنما را از لیست انتخاب کنید.');
            return;
        }
        newArticleData.supervisorId = supervisorId;
        newArticleData.supervisorName = supervisorName;

        const user = getStoredUser();
        const finalData = { ...newArticleData, researcherName: user.name, researcherId: user.nationalId };
        
        const button = event.target;
        const response = await callApi('submitNewArticle', { data: finalData }, button);
        if(response && response.status === 'success'){
            alert(response.message);
            closeAllModals();
            loadArticles(user.nationalId);
        } else {
            alert('خطا: ' + (response.message || 'خطای ناشناخته'));
        }
    }
    
    // --- Edit Article Logic ---
    function showEditArticleModal(article) {
        const modalContent = `
            <div id="edit-article-form">
                <input type="hidden" id="editing-article-id" value="${article.articleId}">
                
                <div class="form-group"><label>عنوان مقاله (غیرقابل ویرایش)</label><input type="text" value="${article.title || ''}" disabled></div>
                <div class="form-group"><label for="edit-affiliation">وابستگی سازمانی</label><input type="text" id="edit-affiliation" value="${article.affiliation || ''}"></div>
                <div class="form-group"><label for="edit-knowledgeArea">حیطه دانشی</label><input type="text" id="edit-knowledgeArea" value="${article.knowledgeArea || ''}"></div>
                <div class="form-group"><label for="edit-topicReason">دلیل انتخاب موضوع</label><textarea id="edit-topicReason">${article.topicReason || ''}</textarea></div>
                
                <div class="form-group">
                    <label for="supervisor-search">استاد راهنما</label>
                    <div class="supervisor-search-container">
                        <input type="text" id="supervisor-search" autocomplete="off" value="${article.supervisorName || ''}">
                        <ul id="supervisor-results" class="hidden"></ul>
                    </div>
                    <input type="hidden" id="selected-supervisor-id" value="${article.supervisorId || ''}">
                    <input type="hidden" id="selected-supervisor-name" value="${article.supervisorName || ''}">
                </div>

                <hr style="margin: 20px 0;">

                <div class="form-group"><label for="edit-abstract">چکیده</label><textarea id="edit-abstract" rows="5">${article.abstract || ''}</textarea></div>
                <div class="form-group"><label for="edit-keywords">کلیدواژه‌ها</label><input type="text" id="edit-keywords" value="${article.keywords || ''}"></div>
                <div class="form-group"><label for="edit-introduction">مقدمه</label><textarea id="edit-introduction" rows="10">${article.introduction || ''}</textarea></div>
                <div class="form-group"><label for="edit-body">بدنه مقاله</label><textarea id="edit-body" rows="15">${article.body || ''}</textarea></div>
                <div class="form-group"><label for="edit-conclusion">نتیجه‌گیری</label><textarea id="edit-conclusion" rows="8">${article.conclusion || ''}</textarea></div>
                <div class="form-group"><label for="edit-references">منابع</label><textarea id="edit-references" rows="8">${article.references || ''}</textarea></div>
                
                <button id="save-all-changes-btn" style="width: 100%; background-color: #27ae60;"><span class="btn-text">ذخیره تمام تغییرات</span></button>
            </div>
        `;
        renderModal(`ویرایش مقاله`, modalContent);
        setupSupervisorSearch(true);
        document.getElementById('save-all-changes-btn').onclick = handleUpdateArticleDetails;
    }
    
    async function handleUpdateArticleDetails(event){
        const button = event.target;
        const articleId = document.getElementById('editing-article-id').value;
        const updates = {
            affiliation: document.getElementById('edit-affiliation').value,
            knowledgeArea: document.getElementById('edit-knowledgeArea').value,
            topicReason: document.getElementById('edit-topicReason').value,
            supervisorName: document.getElementById('selected-supervisor-name').value,
            supervisorId: document.getElementById('selected-supervisor-id').value,
            abstract: document.getElementById('edit-abstract').value,
            keywords: document.getElementById('edit-keywords').value,
            introduction: document.getElementById('edit-introduction').value,
            body: document.getElementById('edit-body').value,
            conclusion: document.getElementById('edit-conclusion').value,
            references: document.getElementById('edit-references').value,
        };
        const response = await callApi('updateArticleDetails', { articleId, updates }, button);
        if(response && response.status === 'success'){
            alert(response.message);
            closeAllModals();
            loadArticles(getStoredUser().nationalId);
        } else {
            alert('خطا در ذخیره: ' + (response.message || 'خطای نامشخص'));
        }
    }

    // --- Supervisor Search Logic ---
    function setupSupervisorSearch(isEditMode = false) {
        const searchInput = document.getElementById('supervisor-search');
        const resultsList = document.getElementById('supervisor-results');
        const idInput = document.getElementById('selected-supervisor-id');
        const nameInput = document.getElementById('selected-supervisor-name');

        searchInput.onkeyup = () => {
            const query = searchInput.value.toLowerCase();
            if (!query) {
                resultsList.classList.add('hidden');
                return;
            }
            const filtered = allSupervisors.filter(s => s.name.toLowerCase().includes(query) || s.id.includes(query));
            resultsList.innerHTML = '';
            if(filtered.length > 0) {
                filtered.forEach(s => {
                    const li = document.createElement('li');
                    li.innerHTML = `${s.name} <span class="supervisor-id">(${s.id})</span>`;
                    li.onclick = () => {
                        searchInput.value = s.name;
                        idInput.value = s.id;
                        nameInput.value = s.name;
                        resultsList.classList.add('hidden');
                    };
                    resultsList.appendChild(li);
                });
                resultsList.classList.remove('hidden');
            } else {
                resultsList.classList.add('hidden');
            }
        };
        // Hide results when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.supervisor-search-container')) {
                resultsList.classList.add('hidden');
            }
        });
        if (isEditMode) {
             searchInput.onfocus = () => { if (allSupervisors.length === 0) callApi('getSupervisors').then(res => { if(res.status === 'success') allSupervisors = res.supervisors; }); }
        }
    }

    // --- Helper Functions ---
    function handleLogout() { localStorage.removeItem('currentUser'); window.location.reload(); }
    function renderModal(title, content) {
        modalContainer.innerHTML = `<div class="modal"><div class="modal-content"><div class="modal-header"><h3>${title}</h3><button class="close-btn">&times;</button></div>${content}</div></div>`;
        modalContainer.querySelector('.close-btn').onclick = closeAllModals;
    }
    function closeAllModals() { modalContainer.innerHTML = ''; }
    function setButtonLoading(button, isLoading) { if(!button) return; button.disabled = isLoading; button.classList.toggle('btn-loading', isLoading); }
    function storeUser(user) { localStorage.setItem('currentUser', JSON.stringify(user)); }
    function getStoredUser() { return JSON.parse(localStorage.getItem('currentUser')); }
    function getStatusInfo(type, code) {
        const map = {
            supervisor: { '1': ['منتظر تایید استاد', '#f39c12'], '5': ['تایید شده توسط استاد', '#2ecc71'], '0': ['رد شده توسط استاد', '#e74c3c'] },
            article: { '1': ['در دست بررسی', '#3498db'], '2': ['نیازمند ویرایش', '#e67e22'], '5': ['تایید نهایی', '#27ae60'], '0': ['رد شده', '#c0392b'] }
        };
        return (map[type] && map[type][String(code)]) || ['نامشخص', '#7f8c8d'];
    }
</script>

</body>
</html>
