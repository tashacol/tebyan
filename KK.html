<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت نشریه</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root {
            --primary: #2563eb; --primary-light: #dbeafe; --primary-dark: #1e40af;
            --secondary: #1f2937; --secondary-light: #f3f4f6;
            --text-dark: #111827; --text-light: #6b7280; --bg-main: #f9fafb;
            --bg-card: #ffffff; --border-color: #e5e7eb; --success: #16a34a;
            --danger: #dc2626; --warning: #f97316; --info: #0ea5e9;
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-lg: 12px; --radius-md: 8px; --transition: 0.2s ease-in-out;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); margin: 0; font-size: 15px; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        h1,h2,h3,h4 { font-weight: 700; margin: 0 0 16px 0; color: var(--text-dark); }
        h1 { font-size: 1.8rem; } h2 { font-size: 1.5rem; } h3 { font-size: 1.2rem; }
        input, select, textarea {
            width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; transition: var(--transition); background-color: #fff;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px var(--primary-light); }
        button {
            font-family: inherit; padding: 10px 16px; border: none; border-radius: var(--radius-md); font-size: 0.95rem; font-weight: 500;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; position: relative; background-color: var(--primary); color: white;
            vertical-align: middle;
        }
        button:hover:not(:disabled) { opacity: 0.85; }
        button:disabled { background-color: #d1d5db; cursor: not-allowed; }
        .btn-success { background-color: var(--success); } .btn-danger { background-color: var(--danger); } .btn-warning { background-color: var(--warning); } .btn-secondary { background-color: #4b5563; }
        .btn-light { background-color: var(--bg-card); color: var(--text-dark); border: 1px solid var(--border-color); }
        
        /* دستور نهم: اصلاح کامل لودینگ دکمه‌ها */
        .btn-loading { color: transparent !important; pointer-events: none; }
        .btn-loading .btn-text, .btn-loading .fas, .btn-loading .fa-solid { visibility: hidden; }
        .btn-loading::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            margin-top: -9px; margin-left: -9px;
            width: 18px; height: 18px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
            border-radius: 50%; animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #main-app { display: flex; min-height: 100vh; }
        #sidebar { width: 250px; background: var(--secondary); color: white; padding: 20px; display: flex; flex-direction: column; flex-shrink: 0; transition: width 0.3s; }
        #sidebar h2 { color: white; border-bottom: 1px solid #4b5563; padding-bottom: 15px; text-align: center; }
        #main-nav { flex-grow: 1; }
        #main-nav button { background: none; width: 100%; justify-content: flex-start; padding: 12px 15px; margin-bottom: 5px; color: #d1d5db; font-size: 1rem; }
        #main-nav button:hover, #main-nav button.active { background: #374151; color: white; }
        #main-nav button i { width: 25px; text-align: center; }
        #logout-btn { margin-top: auto; background: #374151; }
        #main-content { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .loader-wrapper { display: flex; justify-content: center; align-items: center; padding: 60px; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--primary-light); border-bottom-color: var(--primary); border-radius: 50%; display: inline-block; animation: spin 1s linear infinite; }
        
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background: var(--secondary-light); font-weight: 700; white-space: nowrap; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f9fafb; }
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .actions-cell button { padding: 6px 10px; font-size: 0.85rem; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(17, 24, 39, 0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); animation: fadeIn 0.3s; }
        .modal-box { background: var(--bg-card); border-radius: var(--radius-lg); width: 100%; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; max-height: calc(100vh - 40px); animation: zoomIn 0.3s; }
        .modal-xl { max-width: 1100px; } .modal-lg { max-width: 900px; } .modal-md { max-width: 600px; }
        .modal-header, .modal-footer { padding: 16px 24px; flex-shrink: 0; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .modal-footer { border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 8px; }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 24px; }
        .form-group { margin-bottom: 1.2rem; }
        label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-dark); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes zoomIn { from { transform: scale(0.9); } to { transform: scale(1); } }

        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .stat-card { padding: 20px; text-align: center; border-right: 4px solid var(--primary); }
        .stat-card h4 { color: var(--text-light); font-size: 1rem; }
        .stat-card .count { font-size: 2.5rem; font-weight: 700; }
        
        .tab-nav { display:flex; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .tab-nav button { background: none; color: var(--text-light); border-radius: 0; padding: 10px 20px; border-bottom: 3px solid transparent; }
        .tab-nav button.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 700; }
        
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
        .toast { background-color: var(--secondary); color: white; padding: 15px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); margin-top: 10px; opacity: 0; transform: translateY(20px); animation: toast-in 0.5s forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }

        /* دستور سوم و هفتم: استایل‌های مدرن برای مودال مقاله و تاریخچه */
        #article-modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        #article-modal-tabs button { background: none; color: var(--text-light); border: none; padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-size: 1rem; }
        #article-modal-tabs button.active { color: var(--primary); font-weight: 700; border-bottom-color: var(--primary); }
        .tab-content { padding-top: 20px; }
        .history-timeline { list-style: none; padding: 0; }
        .timeline-item { display: flex; gap: 16px; padding: 12px 0; border-bottom: 1px dashed var(--border-color); }
        .timeline-item:last-child { border-bottom: none; }
        .timeline-icon { flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; }
        .timeline-content { flex-grow: 1; }
        .timeline-header { display: flex; justify-content: space-between; align-items: center; font-weight: 500; margin-bottom: 5px; }
        .timeline-title { display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .timeline-details { font-size: 0.9em; color: var(--text-light); word-break: break-word; }
        
        /* دستور هشتم: استایل مدرن مدیریت انتشارات */
        .issue-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 8px; }
        .issue-list-item button { background: none; color: var(--danger); border: none; cursor: pointer; font-size: 1.1rem; padding: 5px; }
        .issue-list-item button:disabled { color: #ccc; cursor: not-allowed; }
        
        /* دستور دوازدهم: استایل مدرن افزودن کاربر از اکسل */
        #drop-area { border: 2px dashed var(--border-color); border-radius: var(--radius-md); padding: 30px; text-align: center; color: var(--text-light); cursor: pointer; transition: var(--transition); }
        #drop-area.highlight { border-color: var(--primary); background-color: var(--primary-light); }
        #file-info { margin-top: 15px; font-weight: 500; }
        
        /* دستور چهارم: استایل برای دانلود PDF */
        #pdf-render-container {
            position: absolute; left: -9999px; top: -9999px; /* Hide it */
            width: 210mm; background: white; color: black;
            font-family: 'Vazirmatn', sans-serif; direction: rtl;
        }
        .pdf-page {
            padding: 15mm; /* دستور اول: حاشیه 1.5 سانت */
            page-break-after: always;
            font-size: 14px; /* دستور دوم: سایز متن */
            line-height: 1.8;
        }
        .pdf-page h3 {
            font-size: 18px; /* دستور دوم: سایز عنوان */
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-top: 0;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="card" style="max-width: 400px; margin: 100px auto; padding: 40px;">
        <div style="text-align:center; margin-bottom: 2rem;">
            <i class="fas fa-shield-alt fa-3x" style="color: var(--primary);"></i>
            <h2 style="margin-top: 1rem;">ورود به پنل مدیریت</h2>
            <p style="color: var(--text-light);">لطفا اطلاعات خود را برای ورود وارد کنید.</p>
        </div>
        <form id="login-form">
            <div class="form-group"><label for="username">نام کاربری</label><input type="text" id="username" required></div>
            <div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div>
            <button type="submit" id="login-btn" style="width: 100%; padding: 12px;"><span class="btn-text">ورود به سیستم</span></button>
            <p id="login-error" style="color:var(--danger); text-align: center; height: 1em; margin-top: 1em;"></p>
        </form>
    </div>
</div>

<div id="main-app" class="hidden">
    <aside id="sidebar">
        <h2><i class="fas fa-landmark"></i> نشریه</h2>
        <nav id="main-nav">
            <button data-view="dashboard" class="active"><i class="fas fa-tachometer-alt fa-fw"></i><span class="nav-text"> داشبورد</span></button>
            <button data-view="articles"><i class="fas fa-file-alt fa-fw"></i><span class="nav-text"> مدیریت مقالات</span></button>
            <button data-view="publications"><i class="fas fa-newspaper fa-fw"></i><span class="nav-text"> مدیریت انتشارات</span></button>
            <button data-view="users"><i class="fas fa-users-cog fa-fw"></i><span class="nav-text"> مدیریت کاربران</span></button>
            <button data-view="logs"><i class="fas fa-history fa-fw"></i><span class="nav-text"> گزارش وقایع</span></button>
        </nav>
        <button id="logout-btn"><i class="fas fa-sign-out-alt"></i><span class="nav-text"> خروج از سیستم</span></button>
    </aside>
    <main id="main-content"><!-- Views will be rendered here --></main>
</div>

<div id="modal-container"></div>
<div id="toast-container"></div>
<div id="pdf-render-container"></div>

<script>
    // ==========================================================
    // == پنل مدیریت نشریه - JavaScript (نسخه نهایی و پایدار)
    // ==========================================================

    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxqsfCE7G7gbMANi-CqxBlIVPQHzIZt54IDQAY-f3PhC46kt5kBvLo1bpp4Xk3KscASvg/exec';

    const appState = {
        currentUser: null,
        isDataLoaded: false,
        data: { articles: [], users: {researchers:[], professors:[]}, publications: {issues:[], readyArticles:[]}, logs: [] }
    };
    
    // دستور پانزدهم: لیست کامل لاگ‌ها
    const LOG_ACTIONS = {
        'LOGIN_SUCCESS': { title: 'ورود محقق', icon: 'fa-right-to-bracket', color: '#6b7280' },
        'SUBMIT_ARTICLE_SUCCESS': { title: 'ثبت نهایی مقاله', icon: 'fa-file-circle-plus', color: 'var(--primary)' },
        'SAVE_DRAFT_SUCCESS': { title: 'ذخیره پیش‌نویس', icon: 'fa-floppy-disk', color: 'var(--secondary)' },
        'SUBMIT_DRAFT_SUCCESS': { title: 'ارسال پیش‌نویس', icon: 'fa-paper-plane', color: 'var(--primary)' },
        'UPDATE_DETAILS_SUCCESS': { title: 'ویرایش اطلاعات کلی', icon: 'fa-pen-to-square', color: 'var(--info)' },
        'UPDATE_SECTION_SUCCESS': { title: 'ویرایش محتوای مقاله', icon: 'fa-file-lines', color: 'var(--info)' },
        'SUBMIT_REVISIONS_SUCCESS': { title: 'ارسال ویرایشات برای استاد', icon: 'fa-file-pen', color: 'var(--primary)' },
        'SEND_FINAL_REVIEW_SUCCESS': { title: 'ارسال برای بررسی نهایی', icon: 'fa-user-check', color: 'var(--success)' },
        'DELETE_ARTICLE_SUCCESS': { title: 'حذف مقاله', icon: 'fa-trash', color: 'var(--danger)' },
        'PROF_LOGIN_SUCCESS': { title: 'ورود استاد', icon: 'fa-right-to-bracket', color: '#6b7280' },
        'GUIDANCE_ACCEPTED': { title: 'پذیرش راهنمایی', icon: 'fa-handshake', color: 'var(--success)' },
        'GUIDANCE_REJECTED': { title: 'عدم پذیرش راهنمایی', icon: 'fa-handshake-slash', color: 'var(--danger)' },
        'SENT_FOR_REVISION': { title: 'ارجاع برای ویرایش (توسط استاد)', icon: 'fa-user-edit', color: 'var(--warning)' },
        'APPROVED_FOR_JOURNAL': { title: 'تایید نهایی توسط استاد', icon: 'fa-user-graduate', color: 'var(--success)' },
        'SUPERVISION_CANCELLED': { title: 'انصراف استاد', icon: 'fa-user-slash', color: 'var(--danger)' },
        'ADMIN_LOGIN_SUCCESS': { title: 'ورود مدیر', icon: 'fa-user-shield', color: '#6b7280' },
        'JOURNAL_ACCEPTED': { title: 'پذیرش نهایی توسط نشریه', icon: 'fa-award', color: 'var(--success)' },
        'JOURNAL_REJECTED': { title: 'رد نهایی توسط نشریه', icon: 'fa-ban', color: 'var(--danger)' },
        'SENT_FOR_FINAL_REVISION': { title: 'ارجاع برای ویرایش نهایی', icon: 'fa-circle-exclamation', color: 'var(--warning)' },
        'ARTICLE_ASSIGNED_TO_ISSUE': { title: 'تخصیص به شماره نشر', icon: 'fa-calendar-check', color: 'var(--primary)' },
        'ISSUE_CREATED': { title: 'ایجاد شماره نشر', icon: 'fa-newspaper', color: 'var(--info)' },
        'USER_CREATED': { title: 'ایجاد کاربر', icon: 'fa-user-plus', color: 'var(--info)' },
        'USER_UPDATED': { title: 'ویرایش کاربر', icon: 'fa-user-pen', color: 'var(--info)' },
        'ISSUE_DELETED': { title: 'حذف شماره نشر', icon: 'fa-trash-can', color: 'var(--danger)'}
    };

    // --- Core Functions: Initialization & API ---
    document.addEventListener('DOMContentLoaded', () => {
        appState.currentUser = JSON.parse(localStorage.getItem('journalAdmin'));
        if (appState.currentUser) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            navigateTo('dashboard');
        }
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.querySelectorAll('#main-nav button').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.view)));
    });

    async function callApi(action, params = {}, button = null) {
        if (button) button.classList.add('btn-loading');
        try {
            const payload = { action, params, adminUsername: appState.currentUser?.username };
            const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`خطای شبکه: ${response.statusText}`);
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);
            return data;
        } catch (error) {
            showToast(error.message, 'error');
            return null;
        } finally {
            if (button) button.classList.remove('btn-loading');
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        const button = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        const response = await callApi('adminLogin', { username: document.getElementById('username').value, password: document.getElementById('password').value }, button);
        if (response?.status === 'success') {
            appState.currentUser = response.user;
            localStorage.setItem('journalAdmin', JSON.stringify(appState.currentUser));
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            navigateTo('dashboard');
        } else {
             loginError.textContent = 'نام کاربری یا رمز عبور اشتباه است.';
        }
    }

    function handleLogout() { localStorage.removeItem('journalAdmin'); window.location.reload(); }
    
    // --- Navigation & View Rendering ---
    async function navigateTo(view) {
        document.querySelectorAll('#main-nav button').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
        const mainContent = document.getElementById('main-content');
        mainContent.innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div>`;

        if (!appState.isDataLoaded) {
             const response = await callApi('getAllData');
             if (response) {
                appState.data = response.data;
                appState.isDataLoaded = true;
             } else {
                mainContent.innerHTML = `<h2>خطا در بارگذاری اطلاعات اولیه. لطفاً صفحه را رفرش کنید.</h2>`;
                return;
             }
        }
        
        switch (view) {
            case 'dashboard': renderDashboardView(); break;
            case 'articles': renderArticlesView(); break;
            case 'publications': renderPublicationsView(); break;
            case 'users': renderUsersView(); break;
            case 'logs': renderLogsView(); break;
        }
    }
    
    // دستور یازدهم: آپدیت داده‌ها بدون رفرش کامل
    function updateAndRender(viewToRender, updatedData) {
        Object.keys(updatedData).forEach(key => {
            if (appState.data[key] !== undefined) {
                appState.data[key] = updatedData[key];
            }
        });
        // Re-render the current view with fresh data
        const currentActive = document.querySelector('#main-nav button.active').dataset.view;
        if (currentActive === viewToRender) {
             switch (viewToRender) {
                case 'articles': renderArticlesView(); break;
                case 'publications': renderPublicationsView(); break;
                case 'users': renderUsersView(); break;
            }
        }
    }
    
    function renderDashboardView() {
        const articles = appState.data.articles;
        const stats = {
            pending: articles.filter(a => String(a.status) === '6').length,
            accepted: articles.filter(a => String(a.status) === '5').length,
            rejected: articles.filter(a => String(a.status) === '0').length,
            total: articles.length
        };
        document.getElementById('main-content').innerHTML = `
            <h1>داشبورد</h1><p>خلاصه وضعیت فعلی سیستم.</p>
            <div class="stat-grid">
                <div class="card stat-card" style="border-right-color: var(--warning);"><h4>منتظر بررسی نشریه</h4><p class="count">${stats.pending}</p></div>
                <div class="card stat-card" style="border-right-color: var(--success);"><h4>پذیرفته شده نهایی</h4><p class="count">${stats.accepted}</p></div>
                <div class="card stat-card" style="border-right-color: var(--danger);"><h4>رد شده نهایی</h4><p class="count">${stats.rejected}</p></div>
                <div class="card stat-card"><h4>کل مقالات ثبت شده</h4><p class="count">${stats.total}</p></div>
            </div>`;
    }
    
    function renderArticlesView() {
        const articles = appState.data.articles;
        document.getElementById('main-content').innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                <h1>مدیریت مقالات (${articles.length})</h1>
                <button class="btn-light" onclick="handleExportExcel()"><i class="fas fa-file-excel"></i> دریافت خروجی اکسل</button>
            </div>
            <div class="card" style="margin-top: 20px;">
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);"><input type="text" id="table-search" placeholder="جستجو در مقالات..." onkeyup="filterTable('articles-table-body', this.value)"></div>
                <div class="table-wrapper"><table>
                    <thead><tr><th>شناسه</th><th>عنوان</th><th>محقق</th><th>استاد راهنما</th><th>وضعیت</th><th>عملیات</th></tr></thead>
                    <tbody id="articles-table-body">
                        ${[...articles].sort((a,b)=>b.articleId-a.articleId).map(a => `
                            <tr>
                                <td>${a.articleId}</td><td>${a.title}</td><td>${a.researcherName}</td><td>${a.supervisorName}</td>
                                <td>${getStatusBadge(a.status)}</td>
                                <td class="actions-cell"><button class="btn-light" onclick="showArticleDetailsModal('${a.articleId}')"><i class="fas fa-eye"></i> مشاهده</button></td>
                            </tr>`).join('') || `<tr><td colspan="6" style="text-align:center; padding: 40px;">مقاله‌ای یافت نشد.</td></tr>`}
                    </tbody>
                </table></div>
            </div>`;
    }

    function renderPublicationsView() {
        const { issues, readyArticles } = appState.data.publications;
        document.getElementById('main-content').innerHTML = `
            <h1>مدیریت انتشارات</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                <div class="card">
                    <h3 style="padding: 20px; border-bottom: 1px solid var(--border-color);">تخصیص مقالات به شماره نشر</h3>
                    <div style="padding: 20px;">
                        <h4>۱. مقالات آماده تخصیص را انتخاب کنید:</h4>
                        <div id="ready-articles-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); padding: 10px; margin-bottom: 1rem; background: #f9fafb; border-radius: var(--radius-md);">
                            ${readyArticles.map(a => `<div><input type="checkbox" id="art-${a.articleId}" value="${a.articleId}" class="article-checkbox"> <label for="art-${a.articleId}">${a.title} (${a.articleId})</label></div>`).join('') || `<p style="color:var(--text-light); text-align:center;">مقاله‌ای برای تخصیص وجود ندارد.</p>`}
                        </div>
                        <h4>۲. شماره نشر مقصد را انتخاب کنید:</h4>
                        <select id="issue-select" style="width:100%;">${[...issues].sort((a,b) => a.issueNumber - b.issueNumber).map(i => `<option value="${i.issueNumber}">${i.issueNumber} (تاریخ نشر: ${formatDate(i.publishDate, false)})</option>`).join('')}</select>
                        <button id="assign-btn" class="btn-success" style="width:100%; margin-top: 15px;">تخصیص مقالات انتخاب شده</button>
                    </div>
                </div>
                <div class="card">
                     <h3 style="padding: 20px; border-bottom: 1px solid var(--border-color);">مدیریت شماره‌های آتی</h3>
                     <div style="padding: 20px;">
                        <div id="issues-list" style="max-height: 200px; overflow-y: auto; margin-bottom: 1rem;">
                            ${[...issues].sort((a,b) => a.issueNumber - b.issueNumber).map(i => {
                                const isPast = new Date(i.publishDate) < new Date();
                                return `<div class="issue-list-item"><span>شماره ${i.issueNumber} - ${formatDate(i.publishDate, false)}</span> <button ${isPast ? 'disabled title="امکان حذف شماره‌های گذشته وجود ندارد"' : `title="حذف شماره ${i.issueNumber}"`} onclick="handleDeleteIssue('${i.issueNumber}', this)"><i class="fas fa-trash"></i></button></div>`;
                            }).join('') || `<p style="color:var(--text-light); text-align:center;">شماره نشری ایجاد نشده است.</p>`}
                        </div>
                        <hr style="margin: 20px 0;">
                        <h4>افزودن شماره جدید</h4>
                        <div class="form-group"><label>شماره نشر (مثلا: ۱۲)</label><input type="number" id="new-issue-number"></div>
                        <div class="form-group"><label>تاریخ نشر</label><input type="date" id="new-issue-date"></div>
                        <button id="add-issue-btn" class="btn-success" style="width:100%;">افزودن</button>
                     </div>
                </div>
            </div>`;
        
        document.getElementById('add-issue-btn').onclick = handleCreateIssue;
        document.getElementById('assign-btn').onclick = handleAssignArticles;
    }
    
    function renderUsersView() {
        const { researchers, professors } = appState.data.users;
        document.getElementById('main-content').innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;"><h1>مدیریت کاربران</h1>
                 <div><button class="btn-secondary" onclick="showImportUsersModal()"><i class="fas fa-file-excel"></i> افزودن از اکسل</button>
                 <button class="btn-success" onclick="showCreateUserModal()"><i class="fas fa-user-plus"></i> افزودن کاربر جدید</button></div>
            </div>
            <div class="card" style="padding: 20px; margin-top: 20px;">
                <div class="tab-nav">
                    <button class="tab-btn active" data-tab="researchers" onclick="switchUserTab('researchers', this)">محققان (${researchers.length})</button>
                    <button class="tab-btn" data-tab="professors" onclick="switchUserTab('professors', this)">اساتید (${professors.length})</button>
                </div>
                <div id="users-content"></div>
            </div>`;
        switchUserTab('researchers', document.querySelector('.tab-btn'));
    }
    
    function renderLogsView() {
        const logs = [...appState.data.logs]
            .filter(log => log.user.includes('(مدیر)'))
            .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
        document.getElementById('main-content').innerHTML = `
            <h1>گزارش وقایع مدیر سیستم</h1>
            <div class="card">
                <div style="padding: 20px; border-bottom: 1px solid var(--border-color);"><input type="text" id="table-search" placeholder="جستجو در لاگ‌ها..." onkeyup="filterTable('logs-table-body', this.value)"></div>
                <div class="table-wrapper"><table>
                    <thead><tr><th>تاریخ</th><th>کاربر</th><th>اقدام</th><th>شناسه مقاله</th><th>جزئیات</th></tr></thead>
                    <tbody id="logs-table-body">
                        ${logs.map(l => {
                            const logInfo = LOG_ACTIONS[l.action] || { title: l.action };
                            return `<tr><td>${formatDate(l.timestamp)}</td><td>${l.user}</td><td>${logInfo.title}</td><td>${l.articleId}</td><td>${l.details}</td></tr>`
                        }).join('')}
                    </tbody>
                </table></div>
            </div>`;
    }
    
    // --- Modals & Dynamic Content ---
    async function showArticleDetailsModal(articleId) {
        showModal('جزئیات مقاله', `<div class="loader-wrapper"><div class="loader"></div></div>`, 'modal-lg');
        const response = await callApi('getArticleDetails', { articleId });
        if (!response) { closeModal('main-modal'); return; }

        const { details, history } = response.data;
        const modalBody = `
            <div id="article-modal-tabs">
                <button class="active" onclick="switchArticleTab('actions', this)">عملیات و وضعیت</button>
                <button onclick="switchArticleTab('content', this)">محتوای مقاله</button>
                <button onclick="switchArticleTab('history', this)">تاریخچه</button>
            </div>
            <div id="actions-content" class="tab-content">
                <h3>${details.title}</h3>
                <p><strong>شناسه:</strong> ${details.articleId} | <strong>محقق:</strong> ${details.researcherName} | <strong>استاد راهنما:</strong> ${details.supervisorName}</p>
                <p><strong>وضعیت فعلی:</strong> ${getStatusBadge(details.articleStatus)}</p>
                <hr style="margin: 20px 0;"><h4>اقدامات مدیریتی</h4><div id="admin-actions"></div>
            </div>
            <div id="content-content" class="tab-content hidden" style="max-height: 400px; overflow-y:auto; line-height: 1.8;">
               <h4>چکیده</h4><p>${details.abstract || 'ثبت نشده'}</p><hr><h4>کلیدواژه</h4><p>${details.keywords || 'ثبت نشده'}</p><hr><h4>مقدمه</h4><p>${details.introduction || 'ثبت نشده'}</p><hr><h4>بدنه</h4><p>${details.body || 'ثبت نشده'}</p><hr><h4>نتیجه گیری</h4><p>${details.conclusion || 'ثبت نشده'}</p><hr><h4>منابع</h4><div style="white-space:pre-wrap;">${details.references || 'ثبت نشده'}</div>
            </div>
            <div id="history-content" class="tab-content hidden" style="max-height: 400px; overflow-y: auto;">
                 <ul class="history-timeline">${history.map(h => {
                     const logInfo = LOG_ACTIONS[h.action] || { title: h.action, icon: 'fa-question-circle', color: 'var(--secondary)' };
                     return `<li class="timeline-item"><div class="timeline-icon" style="background-color:${logInfo.color};"><i class="fa-solid ${logInfo.icon}"></i></div><div class="timeline-content"><div class="timeline-header"><span class="timeline-title">${logInfo.title}</span><small>${formatDate(h.timestamp)}</small></div><p style="font-size:0.9em;">توسط: ${h.user}</p><p class="timeline-details">${h.details || ''}</p></div></li>`
                 }).join('')}</ul>
            </div>`;
            
        updateModalContent('main-modal', modalBody);
        
        const actionsContainer = document.getElementById('admin-actions');
        if (String(details.articleStatus) === '6') {
             actionsContainer.innerHTML = `<p>این مقاله توسط استاد راهنما تایید شده و منتظر تصمیم نهایی نشریه است.</p>
                <div style="display:flex; gap:10px; margin-top: 1rem;">
                    <button class="btn-danger" onclick="showReasonModal('${articleId}', 'reject')"><i class="fas fa-times"></i> رد نهایی</button>
                    <button class="btn-warning" onclick="showReasonModal('${articleId}', 'revise')"><i class="fas fa-edit"></i> ارسال برای ویرایش نهایی</button>
                    <button class="btn-success" id="accept-btn" onclick="handleDecisionClickWrapper('${articleId}', 'accept', null, this)"><i class="fas fa-check"></i> پذیرش نهایی</button>
                </div>`;
        } else {
            actionsContainer.innerHTML = `<p style="color:var(--text-light)">در وضعیت فعلی، اقدامی از سوی شما مورد نیاز نیست.</p>`;
        }
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="handleDownloadPDF(this, '${articleId}')"><i class="fas fa-file-pdf"></i> <span class="btn-text">دانلود PDF</span></button> <button class="btn-secondary" onclick="closeModal('main-modal')">بستن</button>`;
    }
    
    // --- Action Handlers ---
    async function handleDecisionClickWrapper(articleId, decision, reason, button) {
        const res = await callApi('decideOnArticle', { articleId, decision, reason }, button);
        if(res) { 
            showToast(res.message, 'success'); 
            closeModal('main-modal');
            updateAndRender('articles', res.updatedData);
        }
    }
    async function handleCreateIssue(e) {
        const issueNumber = document.getElementById('new-issue-number').value;
        const publishDate = document.getElementById('new-issue-date').value;
        if(!issueNumber || !publishDate) { showToast('لطفا هر دو فیلد را پر کنید.', 'error'); return; }
        const res = await callApi('createPublicationIssue', { issueNumber, publishDate }, e.target);
        if(res) { 
            showToast(res.message, 'success'); 
            appState.data.publications.issues = res.updatedIssues;
            renderPublicationsView();
        }
    }
    async function handleAssignArticles(e) {
        const selectedArticles = Array.from(document.querySelectorAll('.article-checkbox:checked')).map(cb => cb.value);
        const issueNumber = document.getElementById('issue-select').value;
        if(selectedArticles.length === 0 || !issueNumber) { showToast('لطفا حداقل یک مقاله و یک شماره نشر را انتخاب کنید.', 'error'); return; }
        const res = await callApi('assignArticlesToIssue', { articleIds: selectedArticles, issueNumber }, e.target);
        if(res) { 
            showToast(res.message, 'success'); 
            appState.data.articles = res.updatedArticles;
            appState.data.publications.readyArticles = res.updatedReadyArticles;
            renderPublicationsView();
        }
    }
    async function handleDeleteIssue(issueNumber, button) {
        if (!confirm(`آیا از حذف شماره نشر ${issueNumber} اطمینان دارید؟`)) return;
        const res = await callApi('deletePublicationIssue', { issueNumber }, button);
        if (res) {
            showToast(res.message, 'success');
            appState.data.publications.issues = res.updatedIssues;
            renderPublicationsView();
        }
    }
    async function handleCreateUser(button) {
        const userData = { name: document.getElementById('user-name').value, nid: document.getElementById('user-nid').value, pass: document.getElementById('user-pass').value };
        const userType = document.getElementById('user-type').value;
        if(!userData.name || !userData.nid || !userData.pass) { showToast('تمام فیلدها الزامی است.', 'error'); return; }
        const res = await callApi('createUser', { userData, userType }, button);
        if(res) { 
            showToast(res.message, 'success'); 
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }
    async function handleUpdateUser(button) {
        const oldNid = document.getElementById('user-nid-old').value;
        const userData = { name: document.getElementById('user-name-edit').value, nid: document.getElementById('user-nid-edit').value, pass: document.getElementById('user-pass-edit').value };
        const userType = document.getElementById('user-type-edit').value;
         if(!userData.name || !userData.nid) { showToast('نام و کد ملی الزامی است.', 'error'); return; }
        const res = await callApi('updateUser', { oldNid, userData, userType }, button);
        if (res) {
            showToast(res.message, 'success');
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }
    async function handleBatchCreateUsers(button, parsedData, userType) {
        if (!parsedData || parsedData.length === 0) { showToast('داده‌ای برای افزودن یافت نشد.', 'error'); return; }
        const res = await callApi('batchCreateUsers', { users: parsedData, userType }, button);
        if (res) {
            showToast(res.message, 'success');
            closeModal('main-modal');
            appState.data.users = res.updatedUsers;
            renderUsersView();
        }
    }

    // --- More Modals & UI Switches ---
    function showReasonModal(articleId, decision) {
        const title = decision === 'reject' ? 'رد نهایی مقاله' : 'ارسال برای ویرایش';
        const content = `<p>دلیل خود را برای این تصمیم وارد کنید:</p><textarea id="decision-reason" rows="5"></textarea>`;
        showModal(title, content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">لغو</button>
            <button id="confirm-decision-btn" class="${decision === 'reject' ? 'btn-danger' : 'btn-warning'}" onclick="handleDecisionClickWrapper('${articleId}', '${decision}', document.getElementById('decision-reason').value, this)">تایید و ارسال</button>`;
    }
    function showCreateUserModal() {
        const content = `
            <div class="form-group"><label>نوع کاربر</label><select id="user-type"><option value="researcher">محقق</option><option value="professor">استاد</option></select></div>
            <div class="form-group"><label>نام و نام خانوادگی</label><input type="text" id="user-name"></div>
            <div class="form-group"><label>کد ملی (نام کاربری)</label><input type="text" id="user-nid"></div>
            <div class="form-group"><label>رمز عبور</label><input type="text" id="user-pass"></div>`;
        showModal('ایجاد کاربر جدید', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">لغو</button><button class="btn-success" onclick="handleCreateUser(this)">ایجاد کاربر</button>`;
    }
    function showEditUserModal(nid, type) {
        const user = appState.data.users[type].find(u => u.nid === nid);
        if (!user) return;
        const content = `
            <input type="hidden" id="user-nid-old" value="${user.nid}">
            <input type="hidden" id="user-type-edit" value="${type}">
            <div class="form-group"><label>نام و نام خانوادگی</label><input type="text" id="user-name-edit" value="${user.name}"></div>
            <div class="form-group"><label>کد ملی (نام کاربری)</label><input type="text" id="user-nid-edit" value="${user.nid}"></div>
            <div class="form-group"><label>رمز عبور جدید (برای تغییر، وارد کنید)</label><input type="text" id="user-pass-edit" placeholder="در صورت عدم نیاز به تغییر، خالی بگذارید"></div>`;
        showModal('ویرایش کاربر', content, 'modal-md');
        document.getElementById('main-modal-footer').innerHTML = `<button class="btn-light" onclick="closeModal('main-modal')">لغو</button><button class="btn-success" onclick="handleUpdateUser(this)">ذخیره تغییرات</button>`;
    }
    function showImportUsersModal() {
        const content = `
            <p>فایل اکسل خود را اینجا بکشید یا برای انتخاب کلیک کنید.</p>
            <div id="drop-area">
                <input type="file" id="file-input" accept=".xlsx, .xls" style="display: none;">
                <i class="fas fa-upload fa-2x"></i>
                <p>فرمت: ستون A: نام، ستون B: کد ملی، ستون C: رمز عبور</p>
            </div>
            <div id="file-info"></div>
            <div id="import-actions" class="hidden" style="margin-top: 20px;">
                <p>این کاربران به کدام گروه اضافه شوند؟</p>
                <button class="btn-secondary" id="import-researchers-btn"><i class="fas fa-user"></i> افزودن به محققان</button>
                <button class="btn-secondary" id="import-professors-btn"><i class="fas fa-user-tie"></i> افزودن به اساتید</button>
            </div>
        `;
        showModal('افزودن کاربر از اکسل', content, 'modal-md');
        setupExcelDropArea();
    }
    function switchUserTab(tabName, clickedBtn) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
        const contentDiv = document.getElementById('users-content');
        const users = appState.data.users[tabName] || [];
        contentDiv.innerHTML = `<input type="text" placeholder="جستجو در کاربران..." onkeyup="filterTable('${tabName}-table', this.value)" style="margin-bottom: 1rem;">
            <div class="table-wrapper"><table>
            <thead><tr><th>نام</th><th>کد ملی</th>${tabName === 'professors' ? '<th>وضعیت</th>' : ''}<th>عملیات</th></tr></thead><tbody id="${tabName}-table">
            ${users.map(u => `<tr><td>${u.name}</td><td>${u.nid}</td>${tabName === 'professors' ? `<td>${u.status == 5 ? 'فعال' : 'غیرفعال'}</td>` : ''}<td><button class="btn-light btn-sm" onclick="showEditUserModal('${u.nid}', '${tabName}')">ویرایش</button></td></tr>`).join('')}
            </tbody></table></div>`;
    }
    function switchArticleTab(tabName, clickedBtn) {
        document.querySelectorAll('#article-modal-tabs button').forEach(btn => btn.classList.remove('active'));
        clickedBtn.classList.add('active');
        document.querySelectorAll('.tab-content').forEach(div => div.classList.add('hidden'));
        document.getElementById(tabName + '-content').classList.remove('hidden');
    }
    
    // --- Utility Functions ---
    function showModal(title, content, sizeClass = '') {
        closeModal('main-modal');
        document.getElementById('modal-container').innerHTML = `<div class="modal-overlay" id="main-modal" onclick="if (event.target.id === 'main-modal') closeModal('main-modal');"><div class="modal-box ${sizeClass}"><div class="modal-header"><h3>${title}</h3><button onclick="closeModal('main-modal')" style="background:none; border:none; font-size: 1.5rem; cursor:pointer; color: var(--text-light);">&times;</button></div><div class="modal-body">${content}</div><div class="modal-footer" id="main-modal-footer"></div></div></div>`;
    }
    function updateModalContent(modalId, newContent) {
        const modal = document.getElementById(modalId);
        if (modal) modal.querySelector('.modal-body').innerHTML = newContent;
    }
    function closeModal(id) { document.getElementById(id)?.remove(); }
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => { toast.remove(); }, 4000);
    }
    function getStatusBadge(status) {
        const s = String(status);
        const map = {
            '0': { t: 'رد نهایی', c: 'danger' }, '1': { t: 'در دست محقق', c: 'warning' },
            '2': { t: 'در دست محقق (ویرایش)', c: 'warning' }, '4': { t: 'انصراف استاد', c: 'secondary' },
            '5': { t: 'پذیرفته شده', c: 'success' }, '6': { t: 'منتظر تصمیم نشریه', c: 'primary' },
            '8': { t: 'در دست استاد', c: 'info' }, '10':{ t: 'نیازمند ویرایش نهایی', c: 'warning' },
            '11':{ t: 'در دست استاد (بررسی نهایی)', c: 'info'}, '12':{ t: 'در دست استاد (بازبینی)', c: 'info'},
            '9': { t: 'پیش‌نویس محقق', c: 'secondary' }
        };
        const info = map[s] || { t: `نامشخص (${s})`, c: 'secondary' };
        return `<span class="status-badge" style="background-color: var(--${info.c}); color: white;">${info.t}</span>`;
    }
    function filterTable(tableBodyId, searchTerm) {
        const rows = document.getElementById(tableBodyId).rows;
        const term = searchTerm.toLowerCase();
        for (let row of rows) row.style.display = (row.textContent || row.innerText).toLowerCase().includes(term) ? '' : 'none';
    }
    function formatDate(dateString, includeTime = true) {
        if (!dateString) return '-';
        const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
        if (includeTime) { options.hour = '2-digit'; options.minute = '2-digit'; }
        return new Date(dateString).toLocaleDateString('fa-IR', options);
    }
    
    // --- Excel & PDF Export ---
    function setupExcelDropArea() {
        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('file-input');
        let parsedData = [];

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }));
        ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
        ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
        
        dropArea.onclick = () => fileInput.click();
        fileInput.onchange = e => handleFile(e.target.files[0]);
        dropArea.ondrop = e => handleFile(e.dataTransfer.files[0]);

        function handleFile(file) {
            if (!file) return;
            document.getElementById('file-info').textContent = `فایل انتخاب شده: ${file.name}`;
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    parsedData = jsonData.slice(1).map(row => ({ name: row[0], nid: row[1], pass: row[2] })).filter(u => u.name && u.nid && u.pass);
                    document.getElementById('import-actions').classList.remove('hidden');
                    document.getElementById('file-info').textContent += ` - ${parsedData.length} کاربر معتبر یافت شد.`;
                } catch(err) { showToast('خطا در پردازش فایل اکسل.', 'error'); }
            };
            reader.readAsArrayBuffer(file);
        }
        document.getElementById('import-researchers-btn').onclick = (e) => handleBatchCreateUsers(e.target, parsedData, 'researcher');
        document.getElementById('import-professors-btn').onclick = (e) => handleBatchCreateUsers(e.target, parsedData, 'professor');
    }
    async function handleExportExcel() {
        const button = event.target.closest('button');
        if(button) button.classList.add('btn-loading');
        
        const articlesToExport = appState.data.articles;
        const dataToExport = articlesToExport.map(a => ({
            'عنوان مقاله': a.title, 'نام محقق': a.researcherName, 'کد ملی محقق': a.researcherId,
            'استاد راهنما': a.supervisorName, 'کد ملی استاد': a.supervisorId,
            'وضعیت': getStatusBadge(a.status).replace(/<[^>]+>/g, ''),
            'تاریخ ثبت': formatDate(a.requestDate, false),
            'تاریخ پذیرش': formatDate(a.acceptanceDate, false)
        }));
        
        const ws = XLSX.utils.json_to_sheet([]);
        XLSX.utils.sheet_add_aoa(ws, [[`گزارش مقالات کل سیستم - تاریخ: ${formatDate(new Date())}`]], { origin: 'A1' });
        XLSX.utils.sheet_add_json(ws, dataToExport, { origin: 'A2', skipHeader: false });
        
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "گزارش مقالات");
        XLSX.writeFile(wb, `ArticleReport-${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.xlsx`);
        if(button) button.classList.remove('btn-loading');
    }

    async function handleDownloadPDF(button, articleId) {
        if (button) button.classList.add('btn-loading');
        const detailsResponse = await callApi('getArticleDetails', { articleId });
        
        if (!detailsResponse) { if (button) button.classList.remove('btn-loading'); return; }
        
        const details = detailsResponse.data.details;
        const renderContainer = document.getElementById('pdf-render-container');
        
        // دستور چهارم: صفحه‌بندی محتوا
        renderContainer.innerHTML = `
            <div class="pdf-page">
                <h3>اطلاعات کلی</h3>
                <p><strong>عنوان:</strong> ${details.title}</p>
                <p><strong>تاریخ ثبت:</strong> ${formatDate(details.requestDate, false)}</p>
                <p><strong>محقق:</strong> ${details.researcherName}</p>
                <p><strong>استاد راهنما:</strong> ${details.supervisorName}</p>
                <hr>
                <h3>چکیده</h3><p>${details.abstract || '-'}</p>
                <p><strong>کلیدواژه:</strong> ${details.keywords || '-'}</p>
            </div>
            <div class="pdf-page"><h3>مقدمه</h3><p>${(details.introduction || '-').replace(/\n/g, '<br>')}</p></div>
            <div class="pdf-page"><h3>بدنه</h3><p>${(details.body || '-').replace(/\n/g, '<br>')}</p></div>
            <div class="pdf-page"><h3>نتیجه</h3><p>${(details.conclusion || '-').replace(/\n/g, '<br>')}</p></div>
            <div class="pdf-page"><h3>منابع</h3><div style="font-size:12px; white-space:pre-wrap;">${details.references || '-'}</div></div>
        `;

        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            const pages = renderContainer.querySelectorAll('.pdf-page');
            for (let i = 0; i < pages.length; i++) {
                if (i > 0) pdf.addPage();
                const canvas = await html2canvas(pages[i], { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight > pdf.internal.pageSize.getHeight() ? pdf.internal.pageSize.getHeight() : imgHeight);
            }

            // دستور سوم: شماره‌گذاری صفحات
            const pageCount = pdf.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                pdf.setPage(i);
                pdf.setFontSize(10);
                if (i % 2 === 0) { // صفحه زوج
                    pdf.text(String(i), pdf.internal.pageSize.getWidth() - 15, pdf.internal.pageSize.getHeight() - 10);
                } else { // صفحه فرد
                    pdf.text(String(i), 15, pdf.internal.pageSize.getHeight() - 10);
                }
            }

            pdf.save(`Article-${details.articleId}.pdf`);
        } catch(err) {
            showToast('خطا در تولید فایل PDF.', 'error');
            console.error(err);
        } finally {
            renderContainer.innerHTML = ''; // Clean up
            if (button) button.classList.remove('btn-loading');
        }
    }
</script>

</body>
</html>
