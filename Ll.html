 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نشریه علمی پژوهشی</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        
        :root {
            --primary: #1d4ed8; /* آبی رسمی */
            --primary-light: #eff6ff;
            --secondary: #374151; /* خاکستری تیره */
            --bg-main: #f9fafb;
            --bg-card: #ffffff;
            --border-color: #e5e7eb;
            --text-dark: #111827;
            --text-light: #6b7280;
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --radius-md: 8px;
            --transition: 0.3s ease;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'Vazirmatn', sans-serif;
            margin: 0;
            background-color: var(--bg-main);
            color: var(--text-dark);
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .main-header {
            background-color: var(--bg-card);
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .journal-title h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary);
        }
        .journal-title p {
            margin: 0;
            color: var(--text-light);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .btn {
            font-family: inherit; padding: 10px 20px; border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; position: relative;
        }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-light { background-color: transparent; color: var(--text-dark); border: 1px solid var(--border-color); }
        .btn:hover { opacity: 0.85; }

        /* Login Dropdown */
        .login-dropdown {
            position: relative;
        }
        .dropdown-menu {
            position: absolute;
            top: 110%;
            left: 0;
            background-color: var(--bg-card);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            list-style: none;
            padding: 0.5rem;
            margin: 0;
            width: 200px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: var(--transition);
        }
        .dropdown-menu.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .dropdown-menu a {
            display: block;
            padding: 10px 15px;
            text-decoration: none;
            color: var(--text-dark);
            border-radius: 4px;
        }
        .dropdown-menu a:hover {
            background-color: var(--primary-light);
            color: var(--primary);
        }
        .dropdown-menu i { margin-left: 10px; }

        /* Search Section */
        .search-hero {
            padding: 4rem 0;
            text-align: center;
        }
        .search-hero h2 { font-size: 2rem; margin-bottom: 1rem; }
        .search-box {
            display: flex;
            max-width: 600px;
            margin: 0 auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
        }
        #search-input {
            width: 100%;
            border: none;
            padding: 15px 20px;
            font-size: 1.1rem;
            border-radius: var(--radius-md) 0 0 var(--radius-md);
        }
        #search-input:focus { box-shadow: none; }
        #search-btn {
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            padding: 0 25px;
        }

        /* Issues Section */
        #issues-container {
            margin-top: 2rem;
        }
        .issue-accordion details {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
        }
        .issue-accordion summary {
            padding: 1.5rem;
            cursor: pointer;
            list-style: none;
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .issue-accordion summary::-webkit-details-marker { display: none; }
        .issue-accordion summary::after {
            content: '\f078';
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            transition: transform 0.3s;
        }
        .issue-accordion details[open] summary::after {
            transform: rotate(180deg);
        }
        .issue-date {
            font-size: 1rem;
            font-weight: 400;
            color: var(--text-light);
        }
        .articles-list {
            padding: 0 1.5rem 1.5rem 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        .article-card {
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 0;
        }
        .article-card:last-child { border-bottom: none; }
        .article-card h4 { margin: 0 0 8px 0; cursor: pointer; color: var(--primary-dark); }
        .article-card h4:hover { text-decoration: underline; }
        .article-card p { margin: 0; color: var(--text-light); font-size: 0.9rem; }
        .no-results { text-align: center; padding: 2rem; color: var(--text-light); }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: var(--transition);
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-box {
            background: white; border-radius: var(--radius-lg); width: 90%; max-width: 800px;
            max-height: 90vh; display: flex; flex-direction: column;
            transform: scale(0.95); transition: var(--transition);
        }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-body { padding: 1.5rem; overflow-y: auto; line-height: 1.8; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); text-align: left; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }

        .loader-wrapper { display: flex; justify-content: center; align-items: center; min-height: 400px; }
        .loader { width: 48px; height: 48px; border: 5px solid #f3f3f3; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        
        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-light);
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div class="container header-content">
            <div class="journal-title">
                <h1>نشریه علمی-پژوهشی</h1>
                <p>دانشگاه و صنعت</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-light" id="about-btn"><i class="fas fa-info-circle"></i> درباره نشریه</button>
                <div class="login-dropdown">
                    <button class="btn btn-primary" id="login-menu-btn"><i class="fas fa-sign-in-alt"></i> ورود به سامانه</button>
                    <ul class="dropdown-menu" id="login-dropdown-menu">
                        <li><a href="URL_TO_RESEARCHER_PANEL" target="_blank"><i class="fas fa-user-graduate"></i> پنل محققان</a></li>
                        <li><a href="URL_TO_PROFESSOR_PANEL" target="_blank"><i class="fas fa-user-tie"></i> پنل اساتید</a></li>
                        <li><a href="URL_TO_ADMIN_PANEL" target="_blank"><i class="fas fa-user-shield"></i> پنل مدیریت</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <section class="search-hero">
            <h2>آرشیو مقالات منتشر شده</h2>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="جستجو بر اساس عنوان مقاله، نام محقق یا کلیدواژه...">
                <button class="btn btn-primary" id="search-btn"><i class="fas fa-search"></i></button>
            </div>
        </section>
        
        <section id="issues-container" class="issue-accordion">
            <!-- شماره‌های نشریه به صورت پویا در اینجا قرار می‌گیرند -->
        </section>
    </main>
    
    <footer class="main-footer">
        <p>&copy; تمامی حقوق برای این نشریه محفوظ است.</p>
    </footer>

    <div id="modal-container"></div>
    <div id="pdf-render-container" style="position: fixed; left: -9999px; top: -9999px; background: white; color: black; font-family: 'Vazirmatn', sans-serif; direction: rtl; width: 210mm; padding: 1.5cm; box-sizing: border-box;"></div>

<script>
    // ===============================================
    // == JavaScript - صفحه اصلی نشریه
    // ===============================================

    // !مهم: آدرس دیپلوی اسکریپت خود را اینجا قرار دهید
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwftma-QYCexiqqYq6PwEh-D2y0RQKwdqfF3wCTt83G7oAmhfD1h7sDdziD3lmCLp_J/exec';
    let allIssues = [];
    let allArticles = {};

    document.addEventListener('DOMContentLoaded', () => {
        loadPublicationData();
        
        const loginMenuBtn = document.getElementById('login-menu-btn');
        const loginDropdownMenu = document.getElementById('login-dropdown-menu');
        loginMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            loginDropdownMenu.classList.toggle('visible');
        });
        document.addEventListener('click', () => {
            if(loginDropdownMenu.classList.contains('visible')) {
                loginDropdownMenu.classList.remove('visible');
            }
        });
        
        document.getElementById('about-btn').addEventListener('click', showAboutModal);
        document.getElementById('search-input').addEventListener('keyup', handleSearch);
        document.getElementById('search-btn').addEventListener('click', handleSearch);
    });

    async function callApi(action, params = {}) {
        const issuesContainer = document.getElementById('issues-container');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action, params })
            });
            if (!response.ok) throw new Error('خطا در ارتباط با سرور');
            const data = await response.json();
            if (data.status === 'error') throw new Error(data.message);
            return data;
        } catch (error) {
            issuesContainer.innerHTML = `<p class="no-results">${error.message}</p>`;
            return null;
        }
    }

    async function loadPublicationData() {
        const issuesContainer = document.getElementById('issues-container');
        issuesContainer.innerHTML = `<div class="loader-wrapper"><div class="loader"></div></div>`;
        
        const response = await callApi('getPublicationData');
        if (response && response.status === 'success') {
            allIssues = response.data.issues;
            allArticles = response.data.articlesByIssue;
            renderIssues(allIssues, allArticles);
        }
    }

    function renderIssues(issues, articlesByIssue) {
        const issuesContainer = document.getElementById('issues-container');
        issuesContainer.innerHTML = '';

        if (!issues || issues.length === 0) {
            issuesContainer.innerHTML = `<p class="no-results">در حال حاضر هیچ شماره‌ای برای نمایش وجود ندارد.</p>`;
            return;
        }
        
        issues.sort((a, b) => b.issueNumber - a.issueNumber).forEach(issue => {
            const articles = articlesByIssue[issue.issueNumber] || [];
            const articlesHTML = articles.map(article => `
                <div class="article-card" data-title="${article.title.toLowerCase()}" data-author="${article.researcherName.toLowerCase()}" data-keywords="${article.keywords.toLowerCase()}">
                    <h4 onclick="showArticleModal('${article.articleId}')">${article.title}</h4>
                    <p>نویسنده: ${article.researcherName}</p>
                </div>
            `).join('');
            
            const issueHTML = `
                <details>
                    <summary>
                        <span>شماره ${issue.issueNumber}</span>
                        <span class="issue-date">تاریخ نشر: ${formatDate(issue.publishDate)}</span>
                    </summary>
                    <div class="articles-list">
                        ${articlesHTML || `<p class="no-results">مقاله‌ای در این شماره یافت نشد.</p>`}
                    </div>
                </details>
            `;
            issuesContainer.innerHTML += issueHTML;
        });
    }
    
    function handleSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const allArticleCards = document.querySelectorAll('.article-card');
        
        allArticleCards.forEach(card => {
            const title = card.dataset.title;
            const author = card.dataset.author;
            const keywords = card.dataset.keywords;
            
            if (title.includes(searchTerm) || author.includes(searchTerm) || keywords.includes(searchTerm)) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });

        // Check if any issue has become empty and show a message
        document.querySelectorAll('.articles-list').forEach(list => {
            const visibleArticles = list.querySelectorAll('.article-card:not([style*="display: none"])');
            let noResultsMsg = list.querySelector('.no-results');
            if (visibleArticles.length === 0 && !noResultsMsg) {
                const msg = document.createElement('p');
                msg.className = 'no-results';
                msg.textContent = 'مقاله‌ای مطابق با جستجوی شما در این شماره یافت نشد.';
                list.appendChild(msg);
            } else if (visibleArticles.length > 0 && noResultsMsg) {
                noResultsMsg.remove();
            }
        });
    }

    function showAboutModal() {
        const content = `
            <h3>درباره نشریه</h3>
            <p>این نشریه با هدف ترویج دانش و پژوهش در حوزه تعامل میان دانشگاه و صنعت ایجاد شده است. ما به دنبال انتشار مقالات با کیفیت و نوآورانه هستیم که بتوانند به حل مسائل واقعی کمک کنند.</p>
            <h4>اهداف و چشم‌اندازها</h4>
            <ul>
                <li>ایجاد پل ارتباطی میان پژوهشگران دانشگاهی و متخصصان صنعت</li>
                <li>انتشار آخرین دستاوردهای علمی و کاربردی</li>
                <li>فراهم آوردن بستری برای تبادل نظر و همکاری</li>
            </ul>`;
        showModal('درباره ما', content);
    }

    async function showArticleModal(articleId) {
        showModal('درحال بارگذاری...', `<div class="loader-wrapper"><div class="loader"></div></div>`);
        const response = await callApi('getPublishedArticleDetails', { articleId });
        if (response && response.status === 'success') {
            const details = response.data;
            const content = `
                <h3>${details.title}</h3>
                <p><strong>نویسنده:</strong> ${details.researcherName}</p>
                <p><strong>استاد راهنما:</strong> ${details.supervisorName}</p>
                <hr>
                <h4>چکیده</h4>
                <p>${details.abstract}</p>
                <p><strong>کلیدواژه‌ها:</strong> ${details.keywords}</p>
            `;
            updateModal(details.title, content, `<button class="btn btn-primary" id="pdf-download-btn"><i class="fas fa-file-pdf"></i> دانلود PDF کامل مقاله</button>`);
            document.getElementById('pdf-download-btn').onclick = (e) => handleDownloadPDF(details, e.target);
        }
    }
    
    function formatDate(dateString) {
        if (!dateString) return '';
        return new Date(dateString).toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Modal Helpers
    function showModal(title, content) {
        const modalContainer = document.getElementById('modal-container');
        modalContainer.innerHTML = `
            <div class="modal-overlay visible" id="main-modal">
                <div class="modal-box">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="close-btn" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">${content}</div>
                    <div class="modal-footer" id="main-modal-footer">
                        <button class="btn btn-light" onclick="closeModal()">بستن</button>
                    </div>
                </div>
            </div>`;
    }

    function updateModal(title, content, footerContent = '') {
        const modalBox = document.querySelector('#main-modal .modal-box');
        if (modalBox) {
            modalBox.querySelector('.modal-header h3').textContent = title;
            modalBox.querySelector('.modal-body').innerHTML = content;
            if (footerContent) {
                const footer = modalBox.querySelector('.modal-footer');
                footer.innerHTML = footerContent + footer.innerHTML;
            }
        }
    }
    
    function closeModal() {
        const modal = document.getElementById('main-modal');
        if (modal) {
            modal.classList.remove('visible');
            setTimeout(() => modal.remove(), 300);
        }
    }
    
    // PDF Generation
    async function handleDownloadPDF(details, button) {
        if (button) button.classList.add('btn-loading');
        
        const renderContainer = document.getElementById('pdf-render-container');
        
        let content = `
            <div style="text-align:center; margin-bottom: 20px;"><h1 style="font-size:22px; font-weight: 700;">${details.title}</h1></div>
            <p style="font-size: 14px;"><strong>محقق:</strong> ${details.researcherName}</p>
            <p style="font-size: 14px;"><strong>استاد راهنما:</strong> ${details.supervisorName}</p>
            <p style="font-size: 14px;"><strong>تاریخ ثبت:</strong> ${formatDate(details.requestDate, false)}</p>
            <hr style="margin: 20px 0;">
            <h2 style="font-size: 18px; font-weight: 700;">چکیده</h2><p style="font-size: 14px; line-height: 1.8;">${details.abstract || '-'}</p>
            <p style="font-size: 14px;"><strong>کلیدواژه‌ها:</strong> ${details.keywords || '-'}</p>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 18px; font-weight: 700;">مقدمه</h2><div style="font-size: 14px; line-height: 1.8; white-space: pre-wrap;">${details.introduction || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 18px; font-weight: 700;">بدنه اصلی</h2><div style="font-size: 14px; line-height: 1.8; white-space: pre-wrap;">${details.body || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 18px; font-weight: 700;">نتیجه‌گیری</h2><div style="font-size: 14px; line-height: 1.8; white-space: pre-wrap;">${details.conclusion || '-'}</div>
            <div style="page-break-before: always;"></div>
            <h2 style="font-size: 18px; font-weight: 700;">منابع و مآخذ</h2><div style="font-size: 14px; line-height: 1.8; white-space: pre-wrap;">${details.references || '-'}</div>`;
        
        renderContainer.innerHTML = content;
        
        html2canvas(renderContainer, { scale: 3, useCORS: true }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const margin = 15; // 1.5cm
            
            const imgProps = pdf.getImageProperties(imgData);
            const ratio = imgProps.height / imgProps.width;
            const canvasWidth = pdfWidth - (2 * margin);
            const canvasHeight = canvasWidth * ratio;

            let heightLeft = canvasHeight;
            let position = 0;
            let page = 1;

            pdf.addImage(imgData, 'PNG', margin, margin, canvasWidth, canvasHeight);
            pdf.setFontSize(10);
            pdf.text(String(page), margin, pdfHeight - 10);
            heightLeft -= (pdfHeight - (2 * margin));

            while (heightLeft > 0) {
                position -= (pdfHeight - (2 * margin));
                pdf.addPage();
                page++;
                pdf.addImage(imgData, 'PNG', margin, position + margin, canvasWidth, canvasHeight);
                heightLeft -= (pdfHeight - (2 * margin));
                pdf.setFontSize(10);
                pdf.text(String(page), (page % 2 === 0 ? pdfWidth - margin : margin), pdfHeight - 10);
            }

            pdf.save(`Article-${details.articleId}.pdf`);
            renderContainer.innerHTML = '';
            if (button) button.classList.remove('btn-loading');
        });
    }

</script>
</body>
</html>
