<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری اساتید</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root {
            --primary: #4f46e5; --primary-dark: #4338ca; --primary-light: #e0e7ff;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b; --info: #3b82f6;
            --text-dark: #1f2937; --text-light: #6b7280; --bg-main: #f3f4f6;
            --bg-card: #ffffff; --border-color: #d1d5db; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --radius-md: 8px; --radius-lg: 12px; --transition: 0.3s ease;
        }
        body { font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark); margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .hidden { display: none !important; }
        .container { width: 100%; max-width: 1000px; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 30px; border: 1px solid var(--border-color); }
        h1, h2, h3, h4 { color: var(--text-dark); font-weight: 700; margin-top: 0; }
        h1 { font-size: 1.8rem; text-align: center; margin-bottom: 25px; }

        .form-group { margin-bottom: 20px; }
        label { display: block; font-weight: 500; margin-bottom: 8px; color: var(--text-light); }
        input, select, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; transition: var(--transition); background-color: #fff; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); outline: none; }
        button { font-family: inherit; padding: 10px 20px; background-color: var(--primary); color: white; border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 500; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; justify-content: center; gap: 8px; min-height: 44px; position: relative; }
        button:hover:not(:disabled) { background-color: var(--primary-dark); }
        button:disabled { background-color: #9ca3af; cursor: not-allowed; }
        button.btn-success { background-color: var(--success); } button.btn-success:hover:not(:disabled) { background-color: #059669; }
        button.btn-danger { background-color: var(--danger); } button.btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        button.btn-secondary { background-color: #6b7280; } button.btn-secondary:hover:not(:disabled) { background-color: #4b5563; }

        .btn-loading .btn-text, .btn-loading .fas { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 20px; background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); }
        .main-nav { display: flex; gap: 10px; }
        .nav-btn { background-color: var(--bg-main); color: var(--text-dark); }
        .nav-btn.active { background-color: var(--primary); color: white; }
        .user-welcome { font-size: 1.1rem; }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-md); padding: 20px; text-align: center; border-bottom: 4px solid var(--primary); }
        .stat-card .stat-number { font-size: 2.2rem; font-weight: 700; }
        .stat-card .stat-label { font-size: 0.9rem; color: var(--text-light); }
        .stat-card.warning { border-color: var(--warning); }
        .stat-card.success { border-color: var(--success); }
        
        .search-box { flex-grow: 1; position: relative; margin-bottom: 20px; }
        .search-box input { padding-left: 40px; }
        .search-box .search-icon { position: absolute; top: 50%; left: 15px; transform: translateY(-50%); color: var(--text-light); }
        
        .article-group-title { font-size: 1.4rem; padding-bottom: 10px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; }
        .article-card { background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 15px; padding: 20px; border-right: 5px solid var(--primary); cursor: pointer; transition: var(--transition); }
        .article-card:hover { box-shadow: var(--shadow); transform: translateY(-3px); }
        .article-card.type-new-request { border-right-color: var(--warning); }
        .article-card.type-in-progress { border-right-color: var(--primary); }
        .article-card.type-completed { border-right-color: var(--success); opacity: 0.85; }
        .article-header { display: flex; justify-content: space-between; align-items: center; gap: 15px; }
        .article-title { font-size: 1.2rem; font-weight: 700; flex-grow: 1; }
        .article-meta { font-size: 0.9rem; color: var(--text-light); margin-top: 5px; }
        .article-status-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; color: white; background: var(--primary); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(4px); }
        .modal-overlay.visible { opacity: 1; }
        .modal-box { background: var(--bg-card); padding: 30px; border-radius: var(--radius-lg); width: 90%; max-width: 500px; box-shadow: var(--shadow); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box.modal-lg { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 1px solid var(--border-color); margin-bottom: 25px; }
        .modal-header h3 { margin: 0; font-size: 1.3rem; }
        .modal-close-btn { background: none; border: none; font-size: 1.8rem; cursor: pointer; color: var(--text-light); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .review-modal-body { max-height: 70vh; overflow-y: auto; }
        .review-tabs { display: flex; flex-wrap: wrap; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; }
        .review-tab-btn { padding: 10px 15px; border: none; background: none; cursor: pointer; font-size: 1rem; font-family: inherit; border-bottom: 3px solid transparent; margin-bottom: -1px; }
        .review-tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 700; }
        .review-tab-content { display: none; }
        .review-tab-content.active { display: block; }
        .article-content-box { background: var(--bg-main); border-radius: var(--radius-md); padding: 20px; line-height: 1.8; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        
        .custom-alert-actions button { margin-top: 15px; }
    </style>
</head>
<body>

    <div id="alert-container"></div>
    <div class="container">

        <div id="login-page">
            <div class="card" style="max-width: 400px; margin: 80px auto;">
                <h1><i class="fas fa-user-shield"></i> پنل اساتید</h1>
                <form id="login-form">
                    <div class="form-group"><label for="national-id">کد ملی</label><input type="text" id="national-id" required></div>
                    <div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div>
                    <button type="submit" id="login-btn" style="width: 100%;"><span class="btn-text">ورود</span></button>
                    <p id="login-error" style="color: var(--danger); margin-top: 10px; text-align: center; min-height: 1.2em;"></p>
                </form>
            </div>
        </div>

        <div id="main-app" class="hidden">
            <header class="main-header">
                <div class="user-welcome"><strong id="professor-welcome"></strong> خوش آمدید</div>
                <nav class="main-nav">
                    <button class="nav-btn active" data-page="dashboard-page"><i class="fas fa-tachometer-alt fa-fw"></i> داشبورد</button>
                    <button class="nav-btn" data-page="profile-page"><i class="fas fa-user-edit fa-fw"></i> پروفایل</button>
                    <button class="nav-btn" data-page="titles-page"><i class="fas fa-lightbulb fa-fw"></i> عناوین پیشنهادی</button>
                    <button id="logout-btn" class="btn-secondary" style="background-color: #f3f4f6; color: var(--danger);"><i class="fas fa-sign-out-alt fa-fw"></i></button>
                </nav>
            </header>

            <main>
                <div id="dashboard-page" class="page active">
                    <div class="stats-grid">
                        <div class="stat-card warning"><div id="stat-new-requests" class="stat-number">0</div><div class="stat-label">درخواست جدید</div></div>
                        <div class="stat-card"><div id="stat-needs-review" class="stat-number">0</div><div class="stat-label">نیازمند بازبینی</div></div>
                        <div class="stat-card success"><div id="stat-total-guided" class="stat-number">0</div><div class="stat-label">داوری موفق</div></div>
                    </div>
                    <div class="search-box">
                        <input type="text" id="search-input" placeholder="جستجوی مقاله..."><i class="fas fa-search search-icon"></i>
                    </div>
                    <div id="articles-container"></div>
                </div>

                <div id="profile-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-user-edit"></i> ویرایش پروفایل</h3>
                        <div id="profile-form-container"></div>
                    </div>
                </div>

                <div id="titles-page" class="page">
                    <div class="card">
                        <h3><i class="fas fa-lightbulb"></i> مدیریت عناوین پیشنهادی</h3>
                        <div class="form-group">
                            <label for="new-title-input">افزودن عنوان جدید</label>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="new-title-input" placeholder="عنوان پیشنهادی خود را اینجا بنویسید...">
                                <button id="add-title-btn" style="flex-shrink: 0;"><span class="btn-text">افزودن</span></button>
                            </div>
                        </div>
                        <hr style="border:0; border-top:1px solid var(--border-color); margin: 30px 0;">
                        <h4>عناوین ثبت شده توسط شما</h4>
                        <div id="suggested-titles-list"></div>
                    </div>
                </div>
            </main>
             <div id="loader" class="hidden" style="text-align:center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i></div>
        </div>
    </div>
    
    <div id="modal-container"></div>

<script>
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxezFY04wIvrP1xVNue39H3tuSI2sx2rJcxMIW3xdaqUMyNMaNKGWbNsu5b-GVJHAla/exec';
    let allArticles = [];

    // --- DOM Elements ---
    const loginPage = document.getElementById('login-page');
    const mainApp = document.getElementById('main-app');
    const loginForm = document.getElementById('login-form');
    const modalContainer = document.getElementById('modal-container');
    const articlesContainer = document.getElementById('articles-container');

    // --- API Call Function ---
    async function callApi(action, params = {}, button = null) {
        if (button) button.classList.add('btn-loading');
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({ action, params })
            });
            if (!response.ok) throw new Error(`Network error`);
            const data = await response.json();
            if(data.status === 'error' && !data.isNetworkError) console.error('API Error:', data.message);
            return data;
        } catch (error) {
            console.error('API Call Failed:', error);
            return { status: 'error', message: 'خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.', isNetworkError: true };
        } finally {
            if (button) button.classList.remove('btn-loading');
        }
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        const user = getStoredUser();
        if (user) {
            mainApp.classList.remove('hidden');
            loginPage.classList.add('hidden');
            setupApp(user);
        } else {
            loginPage.classList.remove('hidden');
        }
        
        loginForm.addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        document.getElementById('search-input').addEventListener('input', (e) => renderArticles(allArticles, e.target.value));

        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetPageId = e.target.closest('button').dataset.page;
                if (!targetPageId) return;

                document.querySelector('.nav-btn.active').classList.remove('active');
                e.target.closest('button').classList.add('active');

                document.querySelector('.page.active').classList.remove('active');
                document.getElementById(targetPageId).classList.add('active');
                
                if (targetPageId === 'profile-page') loadProfileData();
                if (targetPageId === 'titles-page') loadSuggestedTitles();
            });
        });
        
        document.getElementById('add-title-btn').addEventListener('click', handleAddTitle);
    });

    // --- Authentication ---
    async function handleLogin(e) {
        e.preventDefault();
        const loginError = document.getElementById('login-error');
        loginError.textContent = '';
        const response = await callApi('loginProfessor', {
            nationalId: document.getElementById('national-id').value,
            password: document.getElementById('password').value
        }, document.getElementById('login-btn'));
        
        if (response?.status === 'success') {
            storeUser(response.user);
            loginPage.classList.add('hidden');
            mainApp.classList.remove('hidden');
            setupApp(response.user);
        } else {
            const message = response.isNetworkError ? 'خطای شبکه' : response.message || 'خطایی رخ داد.';
            showCustomAlert(message, 'error');
            loginError.textContent = message;
        }
    }

    function handleLogout() { localStorage.removeItem('currentProfessor'); window.location.reload(); }

    // --- App Setup ---
    function setupApp(user) {
        document.getElementById('professor-welcome').textContent = `سلام، ${user.name}`;
        loadDashboardData(user.nationalId);
    }
    
    // --- Data Loading ---
    async function loadDashboardData(nationalId, showLoader = true) {
        const loader = document.getElementById('loader');
        if (showLoader) {
            loader.classList.remove('hidden');
            articlesContainer.innerHTML = '';
        }
        const response = await callApi('getProfessorDashboard', { nationalId });
        if (showLoader) loader.classList.add('hidden');

        if (response?.status === 'success') {
            allArticles = response.articles;
            renderArticles(response.articles);
            updateStats(response.stats);
        } else {
            showCustomAlert(response.message || 'خطا در بارگذاری اطلاعات', 'error');
        }
    }
    
    // --- UI Rendering ---
    function renderArticles(articles, searchTerm = '') {
        let filteredArticles = articles;
        if (searchTerm) {
            const lowerCaseSearch = searchTerm.toLowerCase().trim();
            filteredArticles = articles.filter(a => a.title.toLowerCase().includes(lowerCaseSearch) || a.researcherName.toLowerCase().includes(lowerCaseSearch));
        }
        const newRequests = filteredArticles.filter(a => a.supervisorStatus == 1);
        const inProgress = filteredArticles.filter(a => a.supervisorStatus == 5 && a.articleStatus != 5 && a.articleStatus != 0);
        const completed = filteredArticles.filter(a => a.supervisorStatus == 5 && (a.articleStatus == 5 || a.articleStatus == 0));
        articlesContainer.innerHTML = '';
        renderGroup('درخواست‌های جدید راهنمایی', newRequests);
        renderGroup('مقالات در حال بررسی', inProgress);
        renderGroup('مقالات تکمیل شده', completed);
        document.getElementById('no-articles-msg').classList.toggle('hidden', filteredArticles.length > 0);
    }

    function renderGroup(title, articles) {
        if (articles.length === 0) return;
        let groupHTML = `<h4 class="article-group-title">${title}</h4>`;
        articles.forEach(article => {
            let cardType = 'type-in-progress', statusText = 'در حال انجام';
            const statusMap = { 1: 'منتظر تصمیم شما', 2: 'ارسال شده برای ویرایش', 6: 'تایید شده توسط شما', 7: 'منتظر اصلاحات جزئی', 8: 'نیازمند بررسی مجدد' };
            if (article.supervisorStatus == 1) { cardType = 'type-new-request'; statusText = 'نیازمند تصمیم‌گیری'; }
            else if (article.articleStatus == 5) { cardType = 'type-completed'; statusText = 'تایید نهایی (منتشر شده)'; }
            else if (article.articleStatus == 0) { cardType = 'type-completed'; statusText = 'رد شده'; }
            else { statusText = statusMap[article.articleStatus] || 'در حال انجام'; }

            groupHTML += `<div class="article-card ${cardType}" data-article-id="${article.articleId}"><div class="article-header"><span class="article-title">${article.title}</span><span class="article-status-badge">${statusText}</span></div><div class="article-meta"><span>محقق: ${article.researcherName}</span> | <span>تاریخ درخواست: ${new Date(article.requestDate).toLocaleDateString('fa-IR')}</span></div></div>`;
        });
        articlesContainer.innerHTML += groupHTML;
    }
    
    articlesContainer.addEventListener('click', (e) => { const card = e.target.closest('.article-card'); if(card && card.dataset.articleId) handleArticleClick(card.dataset.articleId); });

    function updateStats(stats) {
        document.getElementById('stat-new-requests').textContent = stats.newRequests;
        document.getElementById('stat-needs-review').textContent = stats.needsReview;
        document.getElementById('stat-total-guided').textContent = stats.totalGuided;
    }

    // --- Modals & Article Interaction ---
    function handleArticleClick(articleId) { /* ... (بدون تغییر از پاسخ قبل) ... */ }
    function showGuidanceRequestModal(article) { /* ... (بدون تغییر از پاسخ قبل) ... */ }
    function showRejectionReasonModal(article) { /* ... (بدون تغییر از پاسخ قبل) ... */ }
    function showReviewModal(article) { /* ... (بدون تغییر از پاسخ قبل) ... */ }
    async function submitReview(event, articleId, decision) { /* ... (بدون تغییر از پاسخ قبل) ... */ }

    // --- Profile Page ---
    async function loadProfileData() {
        const user = getStoredUser();
        const container = document.getElementById('profile-form-container');
        container.innerHTML = `<div id="loader" style="text-align:center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i></div>`;
        const response = await callApi('getProfessorProfile', { nationalId: user.nationalId });
        if (response?.status === 'success') {
            const profile = response.profile;
            container.innerHTML = `
                <div class="form-group"><label>وضعیت فعالیت</label><select id="profile-status"><option value="5" ${profile.status != 0 ? 'selected' : ''}>فعال</option><option value="0" ${profile.status == 0 ? 'selected' : ''}>غیرفعال</option></select><small class="form-text text-muted">در حالت غیرفعال، درخواست راهنمایی جدیدی دریافت نخواهید کرد.</small></div>
                <div class="form-group"><label for="profile-specializations">تخصص‌ها (حداکثر یک پاراگراف)</label><textarea id="profile-specializations" rows="4">${profile.specializations || ''}</textarea></div>
                <div class="form-group"><label for="profile-max-articles">ظرفیت داوری همزمان</label><input type="number" id="profile-max-articles" value="${profile.maxArticles || ''}" placeholder="مثلاً: 5"></div>
                <div class="form-group"><label for="profile-contact">اطلاعات تماس (ایمیل یا شماره تلفن)</label><input type="text" id="profile-contact" value="${profile.contactInfo || ''}"></div>
                <div style="text-align: left;"><button id="save-profile-btn" class="btn-success"><i class="fas fa-save"></i> ذخیره تغییرات</button></div>`;
            document.getElementById('save-profile-btn').onclick = saveProfile;
        } else { container.innerHTML = `<p style="color:var(--danger)">خطا در دریافت اطلاعات پروفایل.</p>`; }
    }

    async function saveProfile(e) {
        const user = getStoredUser();
        const response = await callApi('updateProfessorProfile', {
            nationalId: user.nationalId, professorName: user.name,
            profileData: {
                status: document.getElementById('profile-status').value,
                specializations: document.getElementById('profile-specializations').value,
                maxArticles: document.getElementById('profile-max-articles').value,
                contactInfo: document.getElementById('profile-contact').value,
            }
        }, e.target);
        showCustomAlert(response.message || 'خطا در ذخیره پروفایل', response.status);
    }

    // --- Suggested Titles Page ---
    async function loadSuggestedTitles() {
        const user = getStoredUser();
        const container = document.getElementById('suggested-titles-list');
        container.innerHTML = `<div id="loader" style="text-align:center; padding: 50px;"><i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i></div>`;
        const response = await callApi('getSuggestedTitles', { nationalId: user.nationalId });
        if (response?.status === 'success') {
            if (!response.titles || response.titles.length === 0) {
                container.innerHTML = '<p>هنوز عنوانی توسط شما ثبت نشده است.</p>';
            } else {
                container.innerHTML = `<ul style="list-style: none; padding: 0;">${response.titles.map(t => `<li style="padding: 10px; border-bottom: 1px solid var(--border-color);">${t.title} <span style="font-size: 0.8rem; background: ${t.status == 5 ? 'var(--success)' : 'var(--secondary)'}; color: white; padding: 2px 8px; border-radius: 12px; margin-right: 10px;">${t.status == 5 ? 'گرفته شده' : 'آزاد'}</span></li>`).join('')}</ul>`;
            }
        } else { container.innerHTML = `<p style="color:var(--danger)">خطا در دریافت عناوین.</p>`; }
    }
    
    async function handleAddTitle(e) {
        const input = document.getElementById('new-title-input');
        const title = input.value.trim();
        if (!title) return showCustomAlert('لطفاً یک عنوان وارد کنید.', 'error');
        
        const user = getStoredUser();
        const response = await callApi('addSuggestedTitle', { title, nationalId: user.nationalId }, e.target);
        if (response.status === 'success') {
            showCustomAlert(response.message, 'success');
            input.value = '';
            loadSuggestedTitles();
        } else {
            showCustomAlert(response.message, 'error');
        }
    }
    
    // --- Utility Functions ---
    function renderModal(title, content, sizeClass = '') { /* ... (بدون تغییر) ... */ }
    function closeModalById(id) { /* ... (بدون تغییر) ... */ }
    function closeAllModals() { /* ... (بدون تغییر) ... */ }
    function showCustomAlert(message, type = 'info', onClose = null) { /* ... (بدون تغییر) ... */ }
    function storeUser(user) { localStorage.setItem('currentProfessor', JSON.stringify(user)); }
    function getStoredUser() { return JSON.parse(localStorage.getItem('currentProfessor')); }
</script>

</body>
</html>
