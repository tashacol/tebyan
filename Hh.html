<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل کاربری اساتید</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        :root {
            --primary: #3B82F6; --primary-light: #EFF6FF; --primary-dark: #2563EB;
            --text-dark: #1f2937; --text-light: #6b7280; --bg-main: #f8f9fa;
            --bg-card: #ffffff; --border-color: #e5e7eb; --success: #10b981;
            --danger: #ef4444; --warning: #f59e0b; --info: #0ea5e9; --purple: #8b5cf6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-lg: 1rem; --radius-md: 0.75rem; --transition: 0.3s ease;
        }
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'Vazirmatn', sans-serif; background-color: var(--bg-main); color: var(--text-dark);
            margin: 0; padding: 2rem; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh;
        }
        .hidden { display: none !important; }
        .container { width: 100%; max-width: 1100px; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: 2rem; }
        h1, h2, h3, h4 { color: var(--text-dark); font-weight: 700; margin: 0 0 1rem 0; }
        label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: var(--text-light); font-size: 0.9rem; }
        input, select, textarea {
            width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color);
            border-radius: var(--radius-md); font-size: 1rem; font-family: inherit; transition: var(--transition); background-color: var(--bg-main);
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: 2px solid transparent; box-shadow: 0 0 0 3px var(--primary-light); }
        button {
            font-family: inherit; padding: 0.75rem 1.25rem; background-color: var(--primary); color: white;
            border: none; border-radius: var(--radius-md); font-size: 1rem; font-weight: 500;
            cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center;
            justify-content: center; gap: 0.5rem; position: relative;
        }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: var(--shadow); }
        button:disabled { background-color: #ced4da; cursor: not-allowed; }
        button.btn-success { background-color: var(--success); } button.btn-danger { background-color: var(--danger); }
        button.btn-warning { background-color: var(--warning); } button.btn-secondary { background-color: var(--text-light); }
        button.btn-icon { padding: 0.75rem; width: 44px; height: 44px; font-size: 1rem; border-radius: 50%; }
        .btn-loading .btn-text, .btn-loading .fas { visibility: hidden; }
        .btn-loading::after { content: ''; position: absolute; top: 50%; left: 50%; margin: -10px 0 0 -10px; width: 20px; height: 20px; border: 3px solid rgba(255, 255, 255, 0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Dashboard Styles */
        .dashboard-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--bg-card); border-radius: var(--radius-md); padding: 1.5rem; display: flex; align-items: center; gap: 1rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
        .stat-icon { font-size: 2rem; padding: 1rem; border-radius: 50%; color: white; }
        .stat-info .stat-number { font-size: 2rem; font-weight: 700; line-height: 1; }
        .stat-info .stat-label { font-size: 0.9rem; color: var(--text-light); }
        .small-loader { width: 24px; height: 24px; border: 3px solid var(--primary-light); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        
        /* Article Card Styles */
        .article-card { background: var(--bg-card); border-radius: var(--radius-md); margin-bottom: 1.5rem; padding: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); transition: var(--transition); display: flex; flex-direction: column; gap: 1rem; }
        .article-card:hover { transform: translateY(-3px); box-shadow: var(--shadow); }
        .article-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .article-title-link { font-size: 1.2rem; font-weight: 700; color: var(--text-dark); text-decoration: none; transition: var(--transition); }
        .article-title-link:hover { color: var(--primary); }
        .status-badge { padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.8rem; font-weight: 500; color: white; display: inline-flex; align-items: center; gap: 0.3rem; }
        .status-badge .small-loader-light { width: 14px; height: 14px; border-width: 2px; border-color: rgba(255,255,255,0.3); border-top-color: white; }
        .article-card-meta { font-size: 0.9rem; color: var(--text-light); display: flex; flex-wrap: wrap; gap: 1rem; }
        .article-card-actions { display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: auto; }
        
        /* Modal Styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(31, 41, 55, 0.5); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 1rem; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.visible { opacity: 1; }
        .modal-box { background: var(--bg-card); padding: 2rem; border-radius: var(--radius-lg); width: 100%; box-shadow: var(--shadow-lg); display: flex; flex-direction: column; max-height: calc(100vh - 4rem); transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-box { transform: scale(1); }
        .modal-box.modal-lg { max-width: 900px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-body { overflow-y: auto; flex-grow: 1; padding: 0 0.5rem; }
        .modal-footer { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 0.75rem; }
        
        /* Accordion Styles */
        .accordion-item { border: 1px solid var(--border-color); border-radius: var(--radius-md); margin-bottom: 1rem; overflow: hidden; }
        .accordion-header { background-color: var(--bg-main); padding: 1rem 1.5rem; cursor: pointer; font-weight: 700; display: flex; justify-content: space-between; align-items: center; position: sticky; top: -1px; z-index: 10; }
        .accordion-header i { transition: transform 0.3s; }
        .accordion-item.open .accordion-header i { transform: rotate(180deg); }
        .accordion-content { padding: 1.5rem; background: white; max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out, padding 0.4s ease-out; }
        .accordion-content.open { max-height: 1000px; }
        .article-content-box { line-height: 1.8; white-space: pre-wrap; }
        .details-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; }
        .details-grid div { background-color: var(--primary-light); padding: 0.75rem; border-radius: var(--radius-md); }
        
        /* Editable Feedback */
        .editable-feedback { padding: 1rem; background-color: var(--primary-light); border-radius: var(--radius-md); display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem; }
        .editable-feedback .edit-icon { cursor: pointer; color: var(--primary); }

        /* Login Page */
        #login-page .card { max-width: 450px; margin: 10vh auto; }

        /* Titles Table */
        .titles-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .titles-table th, .titles-table td { padding: 0.75rem 1rem; text-align: right; border-bottom: 1px solid var(--border-color); }
        .titles-table th { background-color: var(--bg-main); font-weight: 700; }
    </style>
</head>
<body>

    <div id="alert-container"></div>
    <div class="container">

        <div id="login-page">
            <div class="card">
                <div style="text-align:center; margin-bottom: 1.5rem;">
                    <i class="fas fa-university" style="font-size: 3rem; color: var(--primary);"></i>
                    <h1 style="margin-top: 1rem;">پنل اساتید و داوران</h1>
                </div>
                <form id="login-form">
                    <div class="form-group"><label for="national-id">کد ملی</label><input type="text" id="national-id" required></div>
                    <div class="form-group"><label for="password">رمز عبور</label><input type="password" id="password" required></div>
                    <button type="submit" id="login-btn" style="width: 100%;"><span class="btn-text">ورود</span></button>
                    <p id="login-error" style="color: var(--danger); margin-top: 1rem; text-align: center;"></p>
                </form>
            </div>
        </div>

        <div id="dashboard-page" class="hidden">
            <div class="dashboard-header">
                <h3 id="professor-welcome"></h3>
                <div>
                    <button id="manage-titles-btn" class="btn-secondary"><i class="fas fa-lightbulb"></i><span class="btn-text">عناوین پیشنهادی</span></button>
                    <button id="profile-btn" class="btn-secondary"><i class="fas fa-user-cog"></i><span class="btn-text">پروفایل</span></button>
                    <button id="logout-btn" class="btn-danger"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--warning);"><i class="fas fa-inbox"></i></div>
                    <div class="stat-info"><div id="stat-new-requests" class="stat-number">...</div><div class="stat-label">درخواست جدید</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--info);"><i class="fas fa-tasks"></i></div>
                    <div class="stat-info"><div id="stat-needs-review" class="stat-number">...</div><div class="stat-label">نیازمند بازبینی</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background-color: var(--success);"><i class="fas fa-users"></i></div>
                    <div class="stat-info"><div id="stat-capacity" class="stat-number">...</div><div class="stat-label">ظرفیت پذیرش فعال</div></div>
                </div>
            </div>

            <div id="dashboard-content">
                 <div id="articles-container"></div>
                 <div id="no-articles-msg" class="hidden" style="text-align: center; padding: 3rem; color: var(--text-light); background: var(--bg-card); border-radius:var(--radius-md)">مقاله‌ای برای نمایش وجود ندارد.</div>
                 <div id="loader" class="hidden" style="text-align: center; padding: 3rem;"><div class="small-loader" style="width:48px; height:48px; border-width:4px;"></div></div>
            </div>
        </div>
    </div>
    
    <div id="modal-container"></div>

<script>
    // !مهم: آدرس دیپلوی جدید اسکریپت بازنویسی شده اساتید را اینجا قرار دهید
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzm40432lrIkCtE6ZUb6wUQ6cQOJEByi3RLh6G_wnKwwxQIjiFtQZclNDFytd8jWGk/exec'; 
    let allArticles = [];
    let currentProfessor = null;
    const { log: logError } = console;

    // --- DOM Elements & Initializer ---
    document.addEventListener('DOMContentLoaded', () => {
        currentProfessor = JSON.parse(localStorage.getItem('currentProfessor'));
        if (currentProfessor) {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('dashboard-page').classList.remove('hidden');
            document.getElementById('professor-welcome').textContent = `استاد ${currentProfessor.name}، خوش آمدید.`;
            loadDashboardData();
        }
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('logout-btn').onclick = handleLogout;
        document.getElementById('profile-btn').onclick = showProfileModal;
        document.getElementById('manage-titles-btn').onclick = showTitlesModal;
    });

    // --- API & State Management ---
    async function callApi(action, params = {}, button = null) {
        if (button) button.classList.add('btn-loading');
        try {
            const payload = { action, params, professorNid: currentProfessor?.nationalId, professorName: currentProfessor?.name };
            const response = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`Network error: ${response.statusText}`);
            const data = await response.json();
            if (data.status === 'error') {
                showCustomAlert(data.message, 'error');
            }
            return data;
        } catch (error) {
            logError('API Call Failed:', error);
            showCustomAlert('خطا در ارتباط با سرور.', 'error');
            return { status: 'error', message: error.message };
        } finally {
            if (button) button.classList.remove('btn-loading');
        }
    }

    // --- Authentication ---
    async function handleLogin(e) {
        e.preventDefault();
        const nationalId = document.getElementById('national-id').value;
        const password = document.getElementById('password').value;
        const response = await callApi('loginProfessor', { nationalId, password }, e.submitter);
        if (response?.status === 'success') {
            localStorage.setItem('currentProfessor', JSON.stringify(response.user));
            window.location.reload();
        } else {
            document.getElementById('login-error').textContent = response.message || 'خطای نامشخص.';
        }
    }

    function handleLogout() {
        localStorage.removeItem('currentProfessor');
        window.location.reload();
    }

    // --- Dashboard Rendering ---
    async function loadDashboardData(showLoader = true) {
        if(showLoader) {
            document.getElementById('loader').classList.remove('hidden');
            document.getElementById('articles-container').innerHTML = '';
        }
        ['stat-new-requests', 'stat-needs-review', 'stat-capacity'].forEach(id => document.getElementById(id).innerHTML = '<div class="small-loader"></div>');
        
        const response = await callApi('getProfessorDashboard');
        
        if(showLoader) document.getElementById('loader').classList.add('hidden');

        if (response?.status === 'success') {
            allArticles = response.articles;
            renderArticles(allArticles);
            updateStats(response.stats);
        } else {
            updateStats({ newRequests: 'خطا', needsReview: 'خطا', capacity: 'خطا' });
        }
    }

    function renderArticles(articles) {
        const container = document.getElementById('articles-container');
        container.innerHTML = '';
        if (articles.length === 0) {
            document.getElementById('no-articles-msg').classList.remove('hidden');
            return;
        }
        document.getElementById('no-articles-msg').classList.add('hidden');
        articles.forEach(article => {
            const card = document.createElement('div');
            card.className = 'article-card';
            card.dataset.articleId = article.article_id;
            card.innerHTML = createArticleCardHTML(article);
            container.appendChild(card);
        });
    }
    
    function updateArticleCard(article) {
        const existingCard = document.querySelector(`.article-card[data-article-id="${article.article_id}"]`);
        if (existingCard) {
            existingCard.innerHTML = createArticleCardHTML(article);
            // Flash effect
            existingCard.style.transition = 'none';
            existingCard.style.backgroundColor = 'var(--primary-light)';
            setTimeout(() => {
                existingCard.style.transition = 'background-color 0.5s ease';
                existingCard.style.backgroundColor = '';
            }, 100);
        }
        const index = allArticles.findIndex(a => a.article_id === article.article_id);
        if(index > -1) allArticles[index] = article;
    }
    
    function createArticleCardHTML(article) {
        const { text, color } = getStatusInfo(article);
        let actionsHTML = '';
        
        if (String(article.supervisor_status) === '1') {
            actionsHTML = `
                <button class="btn-danger" onclick="showGuidanceRejectionModal('${article.article_id}', event)"><span class="btn-text">عدم پذیرش</span></button>
                <button class="btn-success" onclick="handleGuidanceAccept('${article.article_id}', event)"><span class="btn-text">پذیرش راهنمایی</span></button>`;
        } else if (String(article.supervisor_status) === '5' && !['0', '5'].includes(String(article.article_status))) {
            actionsHTML += `<button class="btn-danger" onclick="showCancelSupervisionModal('${article.article_id}', event)"><i class="fas fa-user-slash"></i><span class="btn-text"> انصراف</span></button>`;
            
            if (['11', '12'].includes(String(article.article_status))) {
                 actionsHTML += `<button class="btn-warning" onclick="showRevisionModal('${article.article_id}', event)"><i class="fas fa-edit"></i><span class="btn-text"> ارسال برای ویرایش</span></button>`;
            }
            if (String(article.article_status) === '11') {
                 actionsHTML += `<button class="btn-success" onclick="showApprovalCommentModal('${article.article_id}', event)"><i class="fas fa-check-double"></i><span class="btn-text"> تایید و ارسال</span></button>`;
            }
        }

        return `
            <div class="article-card-header">
                <div>
                    <a href="#" class="article-title-link" onclick="showDetailsModal('${article.article_id}', event)">${article.title}</a>
                    <div class="article-card-meta">
                        <span><i class="fas fa-user"></i> محقق: ${article.researcher_name}</span>
                        <span><i class="fas fa-calendar-alt"></i> تاریخ: ${new Date(article.request_date).toLocaleDateString('fa-IR')}</span>
                    </div>
                </div>
                <div class="status-badge" style="background-color: ${color}">${text}</div>
            </div>
            ${actionsHTML ? `<div class="article-card-actions">
                <button class="btn-secondary btn-icon" style="margin-left:auto;" onclick="showHistoryModal('${article.article_id}', event)"><i class="fas fa-history"></i></button>
                ${actionsHTML}
            </div>` : ''}
        `;
    }

    function getStatusInfo(article) {
        if (String(article.supervisor_status) === '1') return { text: 'نیازمند تصمیم‌گیری', color: 'var(--warning)' };
        const status = String(article.article_status);
        const map = {
            '0': { text: 'رد شده توسط نشریه', color: 'var(--danger)' }, '1': { text: 'در انتظار تکمیل محقق', color: 'var(--text-light)' },
            '2': { text: 'ارسال شده برای ویرایش', color: 'var(--info)' }, '4': { text: 'انصراف استاد', color: 'var(--danger)' },
            '5': { text: 'تایید نهایی شده', color: 'var(--success)' }, '6': { text: 'منتظر بررسی نهایی', color: 'var(--purple)' },
            '11': { text: 'نسخه نهایی محقق', color: 'var(--primary)' }, '12': { text: 'ویرایش جدید دریافت شد', color: 'var(--purple)' }
        };
        return map[status] || { text: `نامشخص (${status})`, color: '#6c757d' };
    }

    function updateStats(stats) {
        document.getElementById('stat-new-requests').textContent = stats.newRequests ?? 0;
        document.getElementById('stat-needs-review').textContent = stats.needsReview ?? 0;
        document.getElementById('stat-capacity').textContent = `${stats.currentLoad ?? 0}/${stats.capacity || '∞'}`;
    }
    
    // --- Actions & Handlers ---
    
    async function handleGuidanceAccept(articleId, event) {
        event.stopPropagation();
        const res = await callApi('handleGuidanceRequest', { articleId, accepted: true }, event.currentTarget);
        if (res.status === 'success') {
            showCustomAlert(res.message, 'success');
            updateArticleCard(res.updatedArticle);
            loadDashboardData(false); // Reload stats
        }
    }
    
    function showGuidanceRejectionModal(articleId, event) {
        event.stopPropagation();
        renderModal('عدم پذیرش راهنمایی', `
            <div class="modal-body">
                <p>لطفاً دلیل عدم پذیرش راهنمایی این مقاله را وارد کنید. این پیام برای محقق ارسال خواهد شد.</p>
                <textarea id="rejection-reason" rows="4" placeholder="دلیل عدم پذیرش..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">لغو</button>
                <button id="confirm-reject-btn" class="btn-danger"><i class="fas fa-times"></i> ثبت و ارسال</button>
            </div>
        `);
        document.getElementById('confirm-reject-btn').onclick = async e => {
            const reason = document.getElementById('rejection-reason').value;
            if (!reason) return showCustomAlert('لطفاً دلیل را وارد کنید.', 'error');
            const res = await callApi('handleGuidanceRequest', { articleId, accepted: false, reason }, e.currentTarget);
            if(res.status === 'success') {
                closeAllModals();
                showCustomAlert(res.message, 'success');
                updateArticleCard(res.updatedArticle);
                loadDashboardData(false); // Reload stats
            }
        };
    }

    function showCancelSupervisionModal(articleId, event) {
        event.stopPropagation();
        renderModal('انصراف از راهنمایی', `
             <div class="modal-body">
                <p>آیا از انصراف راهنمایی این مقاله اطمینان دارید؟ لطفاً دلیل خود را برای ثبت در سوابق و اطلاع به محقق وارد نمایید.</p>
                <textarea id="cancellation-reason" rows="4" placeholder="دلیل انصراف..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">لغو</button>
                <button id="confirm-cancel-btn" class="btn-danger"><i class="fas fa-user-slash"></i> تایید انصراف</button>
            </div>
        `);
        document.getElementById('confirm-cancel-btn').onclick = async e => {
            const reason = document.getElementById('cancellation-reason').value;
            if (!reason) return showCustomAlert('لطفاً دلیل انصراف را وارد کنید.', 'error');
            const res = await callApi('cancelSupervision', { articleId, reason }, e.currentTarget);
            if(res.status === 'success') {
                closeAllModals();
                showCustomAlert(res.message, 'success');
                updateArticleCard(res.updatedArticle);
                loadDashboardData(false);
            }
        };
    }
    
    function showRevisionModal(articleId, event) {
        event.stopPropagation();
        renderModal('ارسال برای ویرایش', `
            <div class="modal-body">
                <p>توضیحات لازم برای ویرایش مقاله را در کادر زیر بنویسید. این توضیحات برای محقق ارسال خواهد شد.</p>
                <textarea id="revision-feedback" rows="6" placeholder="موارد مورد نیاز برای ویرایش..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">لغو</button>
                <button id="confirm-revision-btn" class="btn-warning"><i class="fas fa-edit"></i> ارسال برای ویرایش</button>
            </div>
        `);
        document.getElementById('confirm-revision-btn').onclick = async e => {
            const feedback = document.getElementById('revision-feedback').value;
            if (!feedback) return showCustomAlert('نوشتن توضیحات برای ویرایش الزامی است.', 'error');
            const res = await callApi('submitArticleReview', { articleId, decision: 'revision', feedback }, e.currentTarget);
            if(res.status === 'success') {
                closeAllModals();
                showCustomAlert(res.message, 'success');
                updateArticleCard(res.updatedArticle);
            }
        };
    }
    
    function showApprovalCommentModal(articleId, event) {
        event.stopPropagation();
        renderModal('تایید و ارسال به نشریه', `
            <div class="modal-body">
                <p>شما در حال تایید نهایی این مقاله و ارسال آن برای نشریه هستید. در صورت تمایل می‌توانید توضیحاتی برای مدیر نشریه ارسال کنید.</p>
                <textarea id="approval-feedback" rows="4" placeholder="توضیحات (اختیاری)..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeAllModals()">لغو</button>
                <button id="confirm-approval-btn" class="btn-success"><i class="fas fa-check-double"></i> تایید و ارسال</button>
            </div>
        `);
        document.getElementById('confirm-approval-btn').onclick = async e => {
            const feedback = document.getElementById('approval-feedback').value;
            const res = await callApi('submitArticleReview', { articleId, decision: 'final_approval', feedback }, e.currentTarget);
            if(res.status === 'success') {
                closeAllModals();
                showCustomAlert(res.message, 'success');
                updateArticleCard(res.updatedArticle);
            }
        };
    }
    
    // --- Modals (Profile, Titles, History, Details) ---
    
    function showDetailsModal(articleId, event) {
        event.preventDefault();
        const article = allArticles.find(a => a.article_id == articleId);
        if (!article) return;
        
        let conditionalContent = '';
        if (String(article.article_status) === '12') { // ویرایش جدید از محقق
            conditionalContent = `<div class="alert-info"><strong>یادداشت محقق:</strong> ${article.action_details || 'یادداشتی ثبت نشده.'}</div>`;
        } else if (String(article.article_status) === '2') { // ارسال شده برای ویرایش
            conditionalContent = `<div class="editable-feedback">
                <p><strong>بازخورد شما:</strong> <span id="feedback-text">${article.action_details}</span></p>
                <i class="fas fa-edit edit-icon" onclick="toggleFeedbackEdit('${article.article_id}', true)"></i>
            </div>`;
        } else if (article.action_details) { // نمایش سایر دلایل
             conditionalContent = `<div class="alert-info">${article.action_details}</div>`;
        }
        
        const content = `<div class="modal-body">
                ${conditionalContent}
                <div class="accordion-item open">
                    <div class="accordion-header">اطلاعات کلی<i class="fas fa-chevron-down"></i></div>
                    <div class="accordion-content open">
                        <div class="details-grid">
                            <div><strong>محقق:</strong> <span>${article.researcher_name}</span></div> <div><strong>وابستگی:</strong> <span>${article.affiliation}</span></div>
                            <div><strong>حیطه دانشی:</strong> <span>${article.knowledge_area}</span></div>
                        </div>
                        <h4 style="margin-top: 20px;">دلیل انتخاب موضوع</h4>
                        <div class="article-content-box">${article.topic_reason || ''}</div>
                    </div>
                </div>
                ${createAccordionItem('چکیده و کلیدواژه', `<strong>کلیدواژه‌ها:</strong> ${article.keywords}<hr>${article.abstract}`)}
                ${createAccordionItem('مقدمه', article.introduction)}
                ${createAccordionItem('بدنه اصلی', article.body)}
                ${createAccordionItem('نتیجه‌گیری', article.conclusion)}
                ${createAccordionItem('منابع', (article.references || '').replace(/\n/g, '<br>'))}
            </div>
            <div id="review-form-container" style="padding: 0 2rem;"></div>`;

        renderModal(`بررسی مقاله: ${article.title}`, content, 'modal-lg');
        
        document.querySelectorAll('.accordion-header').forEach(header => {
            header.onclick = () => {
                const item = header.parentElement;
                item.classList.toggle('open');
                const content = header.nextElementSibling;
                content.classList.toggle('open');
            };
        });
    }

    function createAccordionItem(title, content) {
        return `<div class="accordion-item">
                    <div class="accordion-header">${title}<i class="fas fa-chevron-down"></i></div>
                    <div class="accordion-content"><div class="article-content-box" style="white-space:pre-wrap;">${content || 'ثبت نشده'}</div></div>
                </div>`;
    }
    
    function toggleFeedbackEdit(articleId, isEditing) {
        const container = document.querySelector('.editable-feedback');
        const textSpan = document.getElementById('feedback-text');
        const currentFeedback = textSpan.textContent;

        if(isEditing) {
            container.innerHTML = `
                <textarea id="edit-feedback-textarea" class="form-control" rows="4" style="width:100%">${currentFeedback}</textarea>
                <div style="display:flex; flex-direction:column; gap:0.5rem;">
                    <button class="btn-success btn-icon" onclick="saveFeedbackEdit('${articleId}')"><i class="fas fa-check"></i></button>
                    <button class="btn-secondary btn-icon" onclick="toggleFeedbackEdit('${articleId}', false)"><i class="fas fa-times"></i></button>
                </div>`;
        } else {
             container.innerHTML = `
                <p><strong>بازخورد شما:</strong> <span id="feedback-text">${currentFeedback}</span></p>
                <i class="fas fa-edit edit-icon" onclick="toggleFeedbackEdit('${articleId}', true)"></i>`;
        }
    }

    async function saveFeedbackEdit(articleId) {
        const newFeedback = document.getElementById('edit-feedback-textarea').value;
        const res = await callApi('updateRevisionFeedback', { articleId, feedback: newFeedback });
        if(res.status === 'success') {
            showCustomAlert(res.message, 'success');
            updateArticleCard(res.updatedArticle);
            document.querySelector('.editable-feedback').innerHTML = `<p><strong>بازخورد شما:</strong> <span id="feedback-text">${newFeedback}</span></p> <i class="fas fa-edit edit-icon" onclick="toggleFeedbackEdit('${articleId}', true)"></i>`;
        }
    }

    async function showHistoryModal(articleId, event) {
        event.stopPropagation();
        renderModal('سوابق مقاله', '<div id="history-body" class="modal-body" style="text-align:center;"><div class="small-loader" style="width:48px; height:48px;"></div></div>');
        const res = await callApi('getArticleHistoryForProfessor', { articleId });
        const body = document.getElementById('history-body');
        if (res.status === 'success' && res.history.length > 0) {
            body.innerHTML = `<ul style="list-style:none; padding:0;">${res.history.map(entry => `
                <li style="border-bottom: 1px dashed #eee; padding: 0.75rem 0;">
                    <div><strong>${entry.user}:</strong> ${entry.action} <span style="font-size:0.8rem; color:#6c757d; float:left;">${new Date(entry.timestamp).toLocaleString('fa-IR')}</span></div>
                    <div style="font-size:0.9rem; color:#6c757d; margin-top:0.25rem;">${entry.details || ''}</div>
                </li>`).join('')}</ul>`;
        } else {
            body.innerHTML = '<p>سابقه‌ای یافت نشد.</p>';
        }
    }

    async function showProfileModal() {
        renderModal('مدیریت پروفایل', '<div id="profile-body" class="modal-body" style="text-align:center;"><div class="small-loader" style="width:48px; height:48px;"></div></div>');
        const res = await callApi('getProfessorProfile');
        if (res.status === 'success') {
            const { status, description, capacity, contactInfo } = res.profile;
            document.getElementById('profile-body').parentElement.innerHTML += `
                <div class="modal-body">
                    <div class="form-group"><label>وضعیت حضور</label><select id="profile-status"><option value="5" ${status == 5 ? 'selected' : ''}>فعال</option><option value="0" ${status == 0 ? 'selected' : ''}>غیرفعال</option></select></div>
                    <div class="form-group"><label>ظرفیت داوری همزمان</label><input type="number" id="profile-capacity" value="${capacity || ''}" min="0"></div>
                    <div class="form-group"><label>اطلاعات تماس</label><input type="text" id="profile-contact" value="${contactInfo || ''}"></div>
                    <div class="form-group"><label>تخصص‌ها</label><textarea id="profile-desc" rows="3">${description || ''}</textarea></div>
                </div>
                <div class="modal-footer"><button id="save-profile-btn" class="btn-success"><i class="fas fa-save"></i> ذخیره</button></div>`;
            document.getElementById('profile-body').remove();
            document.getElementById('save-profile-btn').onclick = async e => {
                const profileData = { status: $('#profile-status').value, capacity: $('#profile-capacity').value, contactInfo: $('#profile-contact').value, description: $('#profile-desc').value };
                const saveRes = await callApi('updateProfessorProfile', { profileData }, e.currentTarget);
                if (saveRes.status === 'success') {
                    showCustomAlert(saveRes.message, 'success', () => { closeAllModals(); loadDashboardData(false); });
                }
            };
        }
    }

    async function showTitlesModal() {
         renderModal('مدیریت عناوین پیشنهادی', '<div id="titles-body" class="modal-body" style="text-align:center;"><div class="small-loader" style="width:48px; height:48px;"></div></div>', 'modal-lg');
         const res = await callApi('getSuggestedTitles');
         if (res.status === 'success') {
             const myTitles = res.titles.filter(t => t.professorId.toString() === currentProfessor.nationalId);
             const titlesHTML = myTitles.length > 0 ? myTitles.map(t => `
                <tr>
                    <td>${t.title}</td>
                    <td><span class="status-badge" style="background-color:${t.status == 5 ? 'var(--success)':'var(--text-light)'}">${t.status == 5 ? `پذیرفته شده (${t.articleId})` : 'آزاد'}</span></td>
                </tr>`).join('') : '<tr><td colspan="2">عنوانی ثبت نشده است.</td></tr>';
             
             document.getElementById('titles-body').parentElement.innerHTML += `
                <div class="modal-body">
                    <h4>عناوین پیشنهادی شما</h4>
                    <table class="titles-table"><thead><tr><th>عنوان</th><th>وضعیت</th></tr></thead><tbody>${titlesHTML}</tbody></table>
                    <hr style="margin: 2rem 0;">
                    <h4>افزودن عنوان جدید</h4>
                    <div class="form-group"><input type="text" id="new-title-input" placeholder="عنوان جدید را وارد کنید..."></div>
                </div>
                <div class="modal-footer"><button id="add-title-btn" class="btn-success"><i class="fas fa-plus"></i> افزودن</button></div>`;
            document.getElementById('titles-body').remove();
            document.getElementById('add-title-btn').onclick = async e => {
                const title = $('#new-title-input').value;
                if (!title) return showCustomAlert('لطفاً عنوان را وارد کنید.', 'error');
                const addRes = await callApi('addSuggestedTitle', { title }, e.currentTarget);
                if(addRes.status === 'success') {
                    showCustomAlert(addRes.message, 'success', showTitlesModal);
                }
            };
         }
    }

    // --- Utility Functions ---
    const $ = (selector) => document.querySelector(selector);
    function renderModal(title, content, sizeClass = '') {
        closeAllModals();
        const modalWrapper = document.createElement('div');
        modalWrapper.className = 'modal-overlay';
        modalWrapper.innerHTML = `<div class="modal-box ${sizeClass}"><div class="modal-header"><h3>${title}</h3><button class="btn-icon btn-secondary" style="background:transparent; color: var(--text-light);">&times;</button></div>${content}</div>`;
        document.getElementById('modal-container').appendChild(modalWrapper);
        setTimeout(() => modalWrapper.classList.add('visible'), 10);
        modalWrapper.querySelector('.modal-header button').onclick = () => closeAllModals();
    }
    function closeAllModals() {
        const modal = $('.modal-overlay');
        if (modal) {
            modal.classList.remove('visible');
            modal.addEventListener('transitionend', () => modal.remove());
        }
    }
    function showCustomAlert(message, type = 'info', onClose = null) {
        const icons = { success: 'fa-check-circle', error: 'fa-times-circle', info: 'fa-info-circle' };
        renderModal(
            type === 'success' ? 'موفقیت' : 'خطا',
            `<div class="modal-body" style="text-align:center;">
                <i class="fas ${icons[type]}" style="font-size:3rem; color:var(--${type}); margin-bottom:1rem;"></i>
                <p>${message}</p>
            </div>
            <div class="modal-footer"><button id="alert-ok-btn" class="btn-${type === 'error' ? 'danger' : 'success'}">باشه</button></div>`
        );
        $('#alert-ok-btn').onclick = () => { closeAllModals(); if (onClose) onClose(); };
    }
</script>
</body>
</html>
